# Улучшенная обработка ошибок при загрузке Excel

## 📋 Обзор изменений

Система теперь показывает понятные и информативные сообщения об ошибках при загрузке данных из Excel файлов.

## ✨ Что улучшено

### 1. **Детальная информация об ошибках**
Каждая ошибка теперь содержит:
- 📍 Номер строки в Excel файле
- 🏢 Название предприятия
- 🔢 ИНН предприятия
- 💬 Понятное описание на русском языке
- 🎯 Конкретная колонка с проблемой

### 2. **Типы распознаваемых ошибок**

#### Ошибка типа данных
```
❌ БЫЛО: invalid input syntax for type integer: 'Частная'
✅ СТАЛО: Строка 36 | ООО 'Примерное' (ИНН: 7701234567): 
         Ошибка типа данных в колонке 'Отрасль по СПАРК': 
         ожидается число, получено текстовое значение
```

#### Дубликат ИНН
```
❌ БЫЛО: duplicate key value violates unique constraint
✅ СТАЛО: Строка 15 | АО 'Завод' (ИНН: 7702345678): 
         ИНН 7702345678 уже существует в базе
```

#### Отсутствие обязательных полей
```
❌ БЫЛО: null value in column 'inn' violates not-null constraint
✅ СТАЛО: Строка 42 | ООО 'Компания' (ИНН: Неизвестен): 
         Отсутствует обязательное поле (ИНН или Название)
```

### 3. **Визуальное отображение**

Ошибки показываются в отдельном красном блоке на странице результатов:

```
┌─────────────────────────────────────────────────────────────┐
│ ❌ Обнаружено ошибок: 3                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ • Строка 36 | ООО 'Примерное' (ИНН: 7701234567):      │ │
│ │   Ошибка типа данных в колонке 'Отрасль по СПАРК'     │ │
│ │                                                          │ │
│ │ • Строка 42 | АО 'Завод' (ИНН: 7702345678):           │ │
│ │   ИНН уже существует в базе                            │ │
│ │                                                          │ │
│ │ ... и ещё 1 ошибка                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 Технические детали

### Изменённые файлы:

1. **app/services/excel_processor.py**
   - Улучшена обработка исключений в функции `process_excel_file`
   - Добавлено распознавание типов ошибок
   - Добавлена информация о предприятии в сообщения об ошибках

2. **app/__init__.py**
   - Улучшен обработчик `POST /upload`
   - Добавлены человекопонятные сообщения для глобальных ошибок

3. **app/templates/upload.html**
   - Добавлен блок `.error-section` для отображения ошибок
   - Улучшена функция `showSuccessResult()` для показа деталей ошибок
   - Добавлены стили для error-списка

## 📊 Преимущества

- ✅ Пользователь сразу видит какие строки содержат ошибки
- ✅ Понятно какое именно предприятие вызвало проблему
- ✅ Указано что именно нужно исправить
- ✅ Показываются первые 10 ошибок (не перегружает экран)
- ✅ Загрузка продолжается даже при ошибках в некоторых строках

## 🎯 Пример использования

1. Загрузите Excel файл через веб-интерфейс
2. Если есть ошибки, они будут показаны в красном блоке
3. Откройте Excel файл и найдите указанные строки
4. Исправьте данные согласно описанию ошибки
5. Загрузите файл снова

## 🔍 Как найти проблемную строку в Excel

Номер строки в сообщении соответствует номеру строки в Excel файле.
Например: "Строка 36" = строка 36 в Excel (включая заголовок).

---

**Дата обновления:** 18.10.2025
**Версия:** 2.0
