# Исправление загрузки данных из Excel

## Проблема
Данные по финансам, налогам и зарплатам не загружались из Excel файла в базу данных.

## Причина
Оригинальный код `excel_processor.py` использовал поиск столбцов по именам, но:
1. В Excel некоторые столбцы имеют пробелы в начале названия (например " Выручка предприятия")
2. Встречались двойные пробелы между словами
3. Были опечатки в единицах измерения (.ruб вместо .руб)

## Решение
Создан новый файл `excel_processor_v2.py`, который:
- **Использует индексы столбцов вместо названий** - надежнее и быстрее
- **Безопасно обрабатывает пустые значения** - сохраняет нули (0) как валидные данные
- **Корректно работает с датами** - поддерживает несколько форматов
- **Обрабатывает инвестиции (2021-2023)** и **экспорт (2019-2023)**

### Индексы столбцов (0-based)
```
Базовые данные:
  0: №
  1: ИНН
  2: Наименование организации
  3: Полное наименование
  4-44: Статусы, адреса, ОКВЭД, руководители, контакты

Финансовые метрики (по годам 2017-2023):
  47-53: Выручка
  54-60: Прибыль
  61-67: Численность всего
  68-74: Численность Москва
  75-81: ФОТ всего
  82-88: ФОТ Москва
  89-95: Средняя ЗП всего
  96-102: Средняя ЗП Москва

Налоги (по годам 2017-2024):
  103-110: Налоги всего
  111-118: Налог на прибыль
  119-126: Налог на имущество
  127-134: Налог на землю
  135-142: НДФЛ
  143-150: Транспортный налог
  151-158: Прочие налоги
  159-166: Акцизы

Инвестиции и экспорт:
  167-169: Инвестиции 2021-2023
  170-174: Экспорт 2019-2023

Имущество и продукция:
  175+: Активы, продукция, метаданные
```

## Результат
✅ Все 20 организаций загружены корректно
✅ Метрики за 2017-2023 годы загружены
✅ Налоги за 2017-2024 годы загружены  
✅ Инвестиции и экспорт загружены
✅ Нулевые значения (0) сохраняются как валидные данные
✅ Десятичные числа (58.6, 64.4) обрабатываются корректно

## Проверка данных
Пример: ООО "СВЕТОТЕХНИКА" (ИНН 7706901234)

### 2017 год:
- Выручка: 645,670 тыс. руб.
- Прибыль: 67,890 тыс. руб.
- Численность: 223 чел.
- ФОТ: 156,780 тыс. руб.
- Средняя ЗП: 58.6 тыс. руб.
- Налоги всего: 71,230 тыс. руб.
- НДФЛ: 48,670 тыс. руб.
- Акцизы: 0 (корректно сохранен)

### 2023 год:
- Выручка: 1,334,560 тыс. руб.
- Инвестиции: 94,560 тыс. руб.
- Экспорт: 189,670 тыс. руб.

## Как использовать
1. Загрузите Excel файл через интерфейс `/upload`
2. Система автоматически использует новый процессор `excel_processor_v2.py`
3. Данные сохраняются в таблицы:
   - `organizations` - базовая информация
   - `organization_metrics` - финансовые показатели по годам
   - `organization_taxes` - налоги по годам
   - `organization_assets` - имущество
   - `organization_products` - продукция
   - `organization_meta` - дополнительные данные

## Файлы
- `app/services/excel_processor_v2.py` - новый процессор (ИСПОЛЬЗУЕТСЯ)
- `app/services/excel_processor.py` - старый процессор (сохранен для истории)
- `app/__init__.py` - обновлен импорт на v2
- `app/services/__init__.py` - обновлен импорт на v2

## Утилиты для тестирования
- `clear_database.py` - очистка БД перед загрузкой
- `test_upload.py` - тест загрузки из командной строки
- `check_data.py` - проверка загруженных данных
- `check_excel.py` - анализ структуры Excel файла
