<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Аналитика - МосПром</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
 <style>
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
 background: var(--accent-dark);
 min-height: 100vh;
 padding: 20px;
 }

 .container {
 max-width: 1400px;
 margin: 0 auto;
 }

 .header {
 background: var(--card-bg);
 padding: 30px;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 margin-bottom: 30px;
 display: flex;
 justify-content: space-between;
 align-items: center;
 }

 .header h1 {
 color: var(--accent-dark);
 font-size: 32px;
 margin: 0;
 }

 .header-buttons {
 display: flex;
 gap: 10px;
 }

 .btn {
 background: var(--accent-dark);
 color: var(--card-bg);
 border: none;
 padding: 12px 24px;cursor: pointer;
 font-size: 14px;
 font-weight: 600;
 text-decoration: none;
 display: inline-block;
 transition: transform 0.2s, box-shadow 0.2s;
 }

 .btn:hover {box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 }

 .btn-secondary {
 background: var(--card-bg);
 color: var(--accent-dark);
 border: 2px solid #667eea;
 }

 /* Summary Cards */
 .summary-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
 gap: 20px;
 margin-bottom: 30px;
 }

 .summary-card {
 background: var(--card-bg);
 padding: 25px;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 transition: transform 0.2s;
 }

 .summary-card:hover {}

 .summary-card-icon {
 font-size: 36px;
 margin-bottom: 10px;
 }

 .summary-card-title {
 color: var(--text-secondary);
 font-size: 14px;
 margin-bottom: 8px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .summary-card-value {
 font-size: 32px;
 font-weight: bold;
 color: var(--text-primary);
 margin-bottom: 5px;
 }

 .summary-card-subtitle {
 color: #999;
 font-size: 12px;
 }

 .summary-card-change {
 display: inline-block;
 padding: 4px 8px;font-size: 12px;
 font-weight: 600;
 margin-top: 8px;
 }

 .summary-card-change.positive {
 background: #d4edda;
 color: #155724;
 }

 .summary-card-change.negative {
 background: #f8d7da;
 color: #721c24;
 }

 /* Charts Grid */
 .charts-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
 gap: 20px;
 margin-bottom: 30px;
 }

 .chart-card {
 background: var(--card-bg);
 padding: 25px;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 }

 .chart-card-title {
 font-size: 20px;
 font-weight: bold;
 color: var(--text-primary);
 margin-bottom: 20px;
 display: flex;
 align-items: center;
 gap: 10px;
 }

 .chart-container {
 position: relative;
 height: 300px;
 }

 .chart-container.large {
 height: 400px;
 }

 /* Top Companies Table */
 .top-companies {
 background: var(--card-bg);
 padding: 25px;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 margin-bottom: 30px;
 }

 .top-companies h2 {
 font-size: 24px;
 color: var(--text-primary);
 margin-bottom: 20px;
 }

 .companies-table {
 width: 100%;
 border-collapse: collapse;
 }

 .companies-table th {
 background: var(--accent-light);
 padding: 15px;
 text-align: left;
 font-weight: 600;
 color: var(--text-secondary);
 border-bottom: 2px solid #dee2e6;
 }

 .companies-table td {
 padding: 15px;
 border-bottom: 1px solid #dee2e6;
 }

 .companies-table tr:hover {
 background: var(--accent-light);
 }

 .company-link {
 color: var(--accent-dark);
 text-decoration: none;
 font-weight: 600;
 }

 .company-link:hover {
 text-decoration: underline;
 }

 .rank-badge {
 display: inline-block;
 width: 30px;
 height: 30px;
 line-height: 30px;
 text-align: center;font-weight: bold;
 color: var(--card-bg);
 }

 .rank-1 { background: var(--accent-dark); }
 .rank-2 { background: var(--accent-dark); }
 .rank-3 { background: var(--accent-dark); }
 .rank-other { background: var(--accent-dark); }

 /* Filters */
 .filters-section {
 background: var(--card-bg);
 padding: 20px;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 margin-bottom: 30px;
 }

 .filters-row {
 display: flex;
 gap: 15px;
 flex-wrap: wrap;
 align-items: center;
 }

 .filter-group {
 flex: 1;
 min-width: 200px;
 }

 .filter-group label {
 display: block;
 margin-bottom: 5px;
 color: var(--text-secondary);
 font-size: 14px;
 font-weight: 600;
 }

 .filter-group select {
 width: 100%;
 padding: 10px;
 border: 2px solid #dee2e6;font-size: 14px;
 color: var(--text-primary);
 background: var(--card-bg);
 cursor: pointer;
 }

 .filter-group select:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 /* Loading State */
 .loading {
 text-align: center;
 padding: 40px;
 color: var(--text-secondary);
 }

 .loading-spinner {
 border: 4px solid #f3f3f3;
 border-top: 4px solid #667eea;width: 40px;
 height: 40px;
 animation: spin 1s linear infinite;
 margin: 0 auto 20px;
 }

 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }

 /* Responsive */
 @media (max-width: 768px) {
 .charts-grid {
 grid-template-columns: 1fr;
 }

 .header {
 flex-direction: column;
 gap: 20px;
 }

 .summary-grid {
 grid-template-columns: 1fr;
 }
 }
</style>
</head>
<body>
 <div class="container">
 <div class="header">
 <h1>Аналитика предприятий</h1>
 <div class="header-buttons">
 <a href="/organizations" class="btn btn-secondary">Назад к списку</a>
 <a href="/" class="btn btn-secondary">Главная</a>
</div>
</div>

 <!-- Summary Cards -->
 <div class="summary-grid">
 <div class="summary-card">
 <div class="summary-card-icon"></div>
 <div class="summary-card-title">Всего предприятий</div>
 <div class="summary-card-value">{{ summary.total_organizations }}</div>
 <div class="summary-card-subtitle">зарегистрировано в системе</div>
</div>

 <div class="summary-card">
 <div class="summary-card-icon"></div>
 <div class="summary-card-title">Общая выручка</div>
 <div class="summary-card-value">{{ "%.1f" | format(summary.total_revenue / 1000000000) }} млрд ₽</div>
 <div class="summary-card-subtitle">за последний год</div>
 {% if summary.revenue_change %}
 <span class="summary-card-change {{ 'positive' if summary.revenue_change > 0 else 'negative' }}">
 {{ "%.1f" | format(summary.revenue_change) }}%
</span>
 {% endif %}
</div>

 <div class="summary-card">
 <div class="summary-card-icon"></div>
 <div class="summary-card-title">Всего сотрудников</div>
 <div class="summary-card-value">{{ "{:,}".format(summary.total_employees).replace(",", " ") }}</div>
 <div class="summary-card-subtitle">на всех предприятиях</div>
</div>

 <div class="summary-card">
 <div class="summary-card-icon"></div>
 <div class="summary-card-title">Отрасли</div>
 <div class="summary-card-value">{{ summary.total_industries }}</div>
 <div class="summary-card-subtitle">различных отраслей</div>
</div>
</div>

 <!-- Filters -->
 <div class="filters-section">
 <div class="filters-row">
 <div class="filter-group">
 <label>Период анализа:</label>
 <select id="yearFilter" onchange="updateCharts()">
 <option value="all">Все годы</option>
 {% for year in available_years %}
 <option value="{{ year }}">{{ year }}</option>
 {% endfor %}
</select>
</div>
 <div class="filter-group">
 <label>Отрасль:</label>
 <select id="industryFilter" onchange="updateCharts()">
 <option value="all">Все отрасли</option>
 {% for industry in industries %}
 <option value="{{ industry }}">{{ industry }}</option>
 {% endfor %}
</select>
</div>
 <div class="filter-group">
 <label>Размер компании:</label>
 <select id="sizeFilter" onchange="updateCharts()">
 <option value="all">Все размеры</option>
 <option value="Крупное">Крупное</option>
 <option value="Среднее">Среднее</option>
 <option value="Малое">Малое</option>
 <option value="Микро">Микро</option>
</select>
</div>
</div>
</div>

 <!-- Charts -->
 <div class="charts-grid">
 <div class="chart-card">
 <div class="chart-card-title">Динамика выручки</div>
 <div class="chart-container">
 <canvas id="revenueChart"></canvas>
</div>
</div>

 <div class="chart-card">
 <div class="chart-card-title">Динамика численности</div>
 <div class="chart-container">
 <canvas id="employeesChart"></canvas>
</div>
</div>

 <div class="chart-card">
 <div class="chart-card-title"> Налоговые отчисления</div>
 <div class="chart-container">
 <canvas id="taxesChart"></canvas>
</div>
</div>

 <div class="chart-card">
 <div class="chart-card-title">Распределение по отраслям</div>
 <div class="chart-container">
 <canvas id="industryChart"></canvas>
</div>
</div>
</div>

 <!-- Large chart for detailed analysis -->
 <div class="chart-card">
 <div class="chart-card-title">Комплексный анализ показателей</div>
 <div class="chart-container large">
 <canvas id="complexChart"></canvas>
</div>
</div>

 <!-- Top Companies Table -->
 <div class="top-companies">
 <h2> Топ предприятий по выручке</h2>
 <table class="companies-table">
 <thead>
 <tr>
 <th>#</th>
 <th>Название</th>
 <th>Отрасль</th>
 <th>Выручка (последний год)</th>
 <th>Сотрудники</th>
 <th>Средняя зарплата</th>
</tr>
</thead>
 <tbody>
 {% for org in top_organizations %}
 <tr>
 <td>
 <span class="rank-badge rank-{{ loop.index if loop.index <= 3 else 'other' }}">
 {{ loop.index }}
</span>
</td>
 <td>
 <a href="/organizations/{{ org.id }}" class="company-link">{{ org.name }}</a>
</td>
 <td>{{ org.main_industry or '-' }}</td>
 <td><strong>{{ "{:,.0f}".format(org.revenue).replace(",", " ") }} ₽</strong></td>
 <td>{{ "{:,}".format(org.employees).replace(",", " ") if org.employees else '-' }}</td>
 <td>{{ "{:,.0f}".format(org.avg_salary).replace(",", " ") if org.avg_salary else '-' }} ₽</td>
</tr>
 {% endfor %}
</tbody>
</table>
</div>
</div>

 <script>
 // Chart colors
 const colors = {
 primary: 'rgba(102, 126, 234, 0.8)',
 secondary: 'rgba(118, 75, 162, 0.8)',
 success: 'rgba(40, 167, 69, 0.8)',
 warning: 'rgba(255, 193, 7, 0.8)',
 danger: 'rgba(220, 53, 69, 0.8)',
 info: 'rgba(23, 162, 184, 0.8)'
 };

 // Revenue Chart
 const revenueData = {{ revenue_by_year | tojson }};
 const revenueCtx = document.getElementById('revenueChart').getContext('2d');
 const revenueChart = new Chart(revenueCtx, {
 type: 'line',
 data: {
 labels: revenueData.map(d => d.year),
 datasets: [{
 label: 'Выручка (млрд ₽)',
 data: revenueData.map(d => d.revenue / 1000000000),
 borderColor: colors.primary,
 backgroundColor: colors.primary.replace('0.8', '0.2'),
 tension: 0.4,
 fill: true
 }]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: {
 legend: { display: false }
 },
 scales: {
 y: {
 beginAtZero: true,
 ticks: {
 callback: function(value) {
 return value.toFixed(1) + ' млрд ₽';
 }
 }
 }
 }
 }
 });

 // Employees Chart
 const employeesData = {{ employees_by_year | tojson }};
 const employeesCtx = document.getElementById('employeesChart').getContext('2d');
 const employeesChart = new Chart(employeesCtx, {
 type: 'bar',
 data: {
 labels: employeesData.map(d => d.year),
 datasets: [{
 label: 'Количество сотрудников',
 data: employeesData.map(d => d.employees),
 backgroundColor: colors.success,
 borderRadius: 8
 }]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: {
 legend: { display: false }
 },
 scales: {
 y: {
 beginAtZero: true,
 ticks: {
 callback: function(value) {
 return value.toLocaleString('ru-RU');
 }
 }
 }
 }
 }
 });

 // Taxes Chart
 const taxesData = {{ taxes_by_year | tojson }};
 const taxesCtx = document.getElementById('taxesChart').getContext('2d');
 const taxesChart = new Chart(taxesCtx, {
 type: 'line',
 data: {
 labels: taxesData.map(d => d.year),
 datasets: [{
 label: 'Налоговые отчисления (млн ₽)',
 data: taxesData.map(d => d.taxes / 1000000),
 borderColor: colors.warning,
 backgroundColor: colors.warning.replace('0.8', '0.2'),
 tension: 0.4,
 fill: true
 }]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: {
 legend: { display: false }
 },
 scales: {
 y: {
 beginAtZero: true,
 ticks: {
 callback: function(value) {
 return value.toFixed(1) + ' млн ₽';
 }
 }
 }
 }
 }
 });

 // Industry Distribution Chart
 const industryData = {{ industry_distribution | tojson }};
 const industryCtx = document.getElementById('industryChart').getContext('2d');
 const industryChart = new Chart(industryCtx, {
 type: 'doughnut',
 data: {
 labels: industryData.map(d => d.industry),
 datasets: [{
 data: industryData.map(d => d.count),
 backgroundColor: [
 colors.primary,
 colors.secondary,
 colors.success,
 colors.warning,
 colors.danger,
 colors.info
 ]
 }]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: {
 legend: {
 position: 'right'
 }
 }
 }
 });

 // Complex Analysis Chart
 const complexData = {{ complex_metrics | tojson }};
 const complexCtx = document.getElementById('complexChart').getContext('2d');
 const complexChart = new Chart(complexCtx, {
 type: 'line',
 data: {
 labels: complexData.map(d => d.year),
 datasets: [
 {
 label: 'Выручка (млрд ₽)',
 data: complexData.map(d => d.revenue / 1000000000),
 borderColor: colors.primary,
 backgroundColor: colors.primary.replace('0.8', '0.2'),
 yAxisID: 'y',
 tension: 0.4
 },
 {
 label: 'Прибыль (млн ₽)',
 data: complexData.map(d => d.profit / 1000000),
 borderColor: colors.success,
 backgroundColor: colors.success.replace('0.8', '0.2'),
 yAxisID: 'y',
 tension: 0.4
 },
 {
 label: 'Инвестиции (млн ₽)',
 data: complexData.map(d => d.investments / 1000000),
 borderColor: colors.secondary,
 backgroundColor: colors.secondary.replace('0.8', '0.2'),
 yAxisID: 'y',
 tension: 0.4
 }
 ]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 interaction: {
 mode: 'index',
 intersect: false
 },
 scales: {
 y: {
 type: 'linear',
 display: true,
 position: 'left',
 beginAtZero: true
 }
 }
 }
 });

 // Update charts function (placeholder for future filtering)
 function updateCharts() {
 const year = document.getElementById('yearFilter').value;
 const industry = document.getElementById('industryFilter').value;
 const size = document.getElementById('sizeFilter').value;
 
 // TODO: Implement AJAX call to update charts with filters
 console.log('Filters:', { year, industry, size });
 }
</script>
</body>
</html>
