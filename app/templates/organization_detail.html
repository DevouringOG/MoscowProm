<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>{{ org.name }} - MosProm</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <style>
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 background: var(--accent-dark);
 min-height: 100vh;
 padding: 20px;
 }

 .container {
 max-width: 1400px;
 margin: 0 auto;
 background: var(--card-bg);box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 overflow: hidden;
 }

 .header {
 background: var(--accent-dark);
 color: var(--card-bg);
 padding: 30px;
 }

 .header-actions {
 display: flex;
 gap: 10px;
 margin-bottom: 20px;
 flex-wrap: wrap;
 }

 .back-btn,
 .edit-btn,
 .delete-btn,
 .fns-btn {
 display: inline-flex;
 align-items: center;
 gap: 8px;
 color: var(--card-bg);
 text-decoration: none;
 padding: 8px 16px;
 background: rgba(255, 255, 255, 0.2);transition: background 0.3s ease;
 border: none;
 cursor: pointer;
 font-size: 14px;
 }

 .back-btn:hover,
 .edit-btn:hover,
 .fns-btn:hover {
 background: rgba(255, 255, 255, 0.3);
 }

 .fns-btn {
 background: rgba(0, 123, 255, 0.8);
 }

 .fns-btn:hover {
 background: rgba(0, 123, 255, 1);
 }

 .fns-btn:disabled {
 opacity: 0.5;
 cursor: not-allowed;
 }

 .delete-btn {
 background: rgba(220, 53, 69, 0.8);
 }

 .delete-btn:hover {
 background: rgba(220, 53, 69, 1);
 }

 .org-title {
 font-size: 32px;
 font-weight: 600;
 margin-bottom: 10px;
 }

 .org-subtitle {
 display: flex;
 gap: 20px;
 align-items: center;
 flex-wrap: wrap;
 }

 .inn-badge {
 background: rgba(255, 255, 255, 0.3);
 padding: 6px 16px;font-family: 'Courier New', monospace;
 font-size: 14px;
 }

 .tabs {
 display: flex;
 background: var(--accent-light);
 border-bottom: 2px solid #dee2e6;
 overflow-x: auto;
 }

 .tab {
 padding: 16px 24px;
 background: transparent;
 border: none;
 cursor: pointer;
 font-size: 15px;
 font-weight: 500;
 color: var(--text-secondary);
 white-space: nowrap;
 transition: all 0.3s ease;
 border-bottom: 3px solid transparent;
 }

 .tab:hover {
 color: var(--accent-dark);
 background: rgba(102, 126, 234, 0.05);
 }

 .tab.active {
 color: var(--accent-dark);
 border-bottom-color: var(--accent-dark);
 background: var(--card-bg);
 }

 .tab-content {
 display: none;
 padding: 30px;
 animation: fadeIn 0.3s ease;
 }

 .tab-content.active {
 display: block;
 }

 @keyframes fadeIn {
 from { opacity: 0;}
 to { opacity: 1;}
 }

 .info-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
 gap: 20px;
 margin-bottom: 30px;
 }

 .info-card {
 background: var(--accent-light);
 padding: 20px;border-left: 4px solid #667eea;
 }

 .info-label {
 color: var(--text-secondary);
 font-size: 13px;
 font-weight: 500;
 margin-bottom: 8px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .info-value {
 color: #212529;
 font-size: 16px;
 font-weight: 500;
 }

 .info-value.large {
 font-size: 24px;
 color: var(--accent-dark);
 }

 .table-responsive {
 overflow-x: auto;
 margin-top: 20px;
 }

 table {
 width: 100%;
 border-collapse: collapse;
 background: var(--card-bg);
 }

 thead {
 background: var(--accent-light);
 }

 th {
 padding: 12px;
 text-align: left;
 font-weight: 600;
 color: var(--text-secondary);
 border-bottom: 2px solid #dee2e6;
 font-size: 13px;
 }

 td {
 padding: 12px;
 border-bottom: 1px solid #e9ecef;
 font-size: 14px;
 }

 tbody tr:hover {
 background: var(--accent-light);
 }

 .section-title {
 font-size: 20px;
 font-weight: 600;
 color: #212529;
 margin-bottom: 20px;
 padding-bottom: 10px;
 border-bottom: 2px solid #e9ecef;
 }

 .no-data {
 text-align: center;
 padding: 40px;
 color: var(--text-secondary);
 font-size: 16px;
 }

 .badge {
 display: inline-block;
 padding: 4px 12px;font-size: 12px;
 font-weight: 500;
 }

 .badge-success {
 background: #d4edda;
 color: #155724;
 }

 .badge-danger {
 background: #f8d7da;
 color: #721c24;
 }

 .badge-info {
 background: #d1ecf1;
 color: #0c5460;
 }

 .metric-highlight {
 background: var(--accent-dark);
 color: var(--card-bg);
 padding: 20px;margin-bottom: 20px;
 }

 .metric-row {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 10px;
 }

 .metric-row:last-child {
 margin-bottom: 0;
 }
</style>
</head>
<body>
 <div class="container">
 <div class="header">
 <div class="header-actions">
 <a href="/organizations" class="back-btn">← Назад к списку</a>
 <a href="/organizations/{{ org.id }}/analytics" class="edit-btn">Аналитика</a>
 <a href="/organizations/{{ org.id }}/edit" class="edit-btn">Редактировать</a>
 <button onclick="updateFromFNS()" class="fns-btn" id="fnsBtn">⟳ ОБНОВИТЬ ИЗ ФНС</button>
 <button onclick="deleteOrganization()" class="delete-btn"> Удалить</button>
</div>
 <h1 class="org-title">{{ org.name }}</h1>
 <div class="org-subtitle">
 <span class="inn-badge">ИНН: {{ org.inn }}</span>
 {% if org.status_final %}
 <span>{{ org.status_final }}</span>
 {% endif %}
</div>
</div>

 <div class="tabs">
 <button class="tab active" onclick="showTab('general')">Общие данные</button>
 <button class="tab" onclick="showTab('metrics')">Финансовые показатели</button>
 <button class="tab" onclick="showTab('taxes')">Налоги</button>
 <button class="tab" onclick="showTab('assets')"> Имущество</button>
 <button class="tab" onclick="showTab('products')"> Продукция</button>
 <button class="tab" onclick="showTab('contacts')"> Контакты</button>
</div>

 <!-- Общие данные -->
 <div id="general" class="tab-content active">
 <h2 class="section-title">Основная информация</h2>
 <div class="info-grid">
 <div class="info-card">
 <div class="info-label">Полное наименование</div>
 <div class="info-value">{{ org.full_name or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">ИНН</div>
 <div class="info-value large">{{ org.inn }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Статус</div>
 <div class="info-value">{{ org.status_final or org.status_spark or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Дата регистрации</div>
 <div class="info-value">{{ org.registration_date.strftime('%d.%m.%Y') if org.registration_date else '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Основная отрасль</div>
 <div class="info-value">{{ org.main_industry or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Подотрасль</div>
 <div class="info-value">{{ org.main_subindustry or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Размер предприятия</div>
 <div class="info-value">{{ org.company_size or org.company_size_2022 or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Статус МСП</div>
 <div class="info-value">{{ org.msp_status or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Руководитель</div>
 <div class="info-value">{{ org.head_name or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Округ</div>
 <div class="info-value">{{ org.district or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Район</div>
 <div class="info-value">{{ org.region or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Системообразующее</div>
 <div class="info-value">
 {% if org.is_system_critical %}
 <span class="badge badge-success">Да</span>
 {% else %}
 <span class="badge badge-info">Нет</span>
 {% endif %}
</div>
</div>
</div>

 <h2 class="section-title">Адреса</h2>
 <div class="info-grid">
 <div class="info-card">
 <div class="info-label">Юридический адрес</div>
 <div class="info-value">{{ org.legal_address or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Адрес производства</div>
 <div class="info-value">{{ org.production_address or '—' }}</div>
</div>
 {% if org.additional_address %}
 <div class="info-card">
 <div class="info-label">Дополнительная площадка</div>
 <div class="info-value">{{ org.additional_address }}</div>
</div>
 {% endif %}
</div>

 <h2 class="section-title">ОКВЭД</h2>
 <div class="info-grid">
 <div class="info-card">
 <div class="info-label">Основной ОКВЭД</div>
 <div class="info-value">{{ org.main_okved or '—' }}</div>
 <div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">
 {{ org.main_okved_name or '' }}
</div>
</div>
 <div class="info-card">
 <div class="info-label">Производственный ОКВЭД</div>
 <div class="info-value">{{ org.prod_okved or '—' }}</div>
 <div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">
 {{ org.prod_okved_name or '' }}
</div>
</div>
</div>
</div>

 <!-- Финансовые показатели -->
 <div id="metrics" class="tab-content">
 <h2 class="section-title">Финансово-экономические показатели по годам</h2>
 {% if metrics %}
 <div class="table-responsive">
 <table>
 <thead>
 <tr>
 <th>Год</th>
 <th>Выручка, тыс.₽</th>
 <th>Прибыль, тыс.₽</th>
 <th>Численность (всего)</th>
 <th>Численность (МСК)</th>
 <th>ФОТ (всего), тыс.₽</th>
 <th>ФОТ (МСК), тыс.₽</th>
 <th>Инвестиции, тыс.₽</th>
 <th>Экспорт, тыс.₽</th>
</tr>
</thead>
 <tbody>
 {% for m in metrics %}
 <tr>
 <td><strong>{{ m.year }}</strong></td>
 <td>{{ '{:,.0f}'.format(m.revenue).replace(',', ' ') if m.revenue else '—' }}</td>
 <td>{{ '{:,.0f}'.format(m.profit).replace(',', ' ') if m.profit else '—' }}</td>
 <td>{{ m.total_employees or '—' }}</td>
 <td>{{ m.moscow_employees or '—' }}</td>
 <td>{{ '{:,.0f}'.format(m.total_fot).replace(',', ' ') if m.total_fot else '—' }}</td>
 <td>{{ '{:,.0f}'.format(m.moscow_fot).replace(',', ' ') if m.moscow_fot else '—' }}</td>
 <td>{{ '{:,.0f}'.format(m.investments).replace(',', ' ') if m.investments else '—' }}</td>
 <td>{{ '{:,.0f}'.format(m.export_volume).replace(',', ' ') if m.export_volume else '—' }}</td>
</tr>
 {% endfor %}
</tbody>
</table>
</div>
 {% else %}
 <div class="no-data">Финансовые данные отсутствуют</div>
 {% endif %}
</div>

 <!-- Налоги -->
 <div id="taxes" class="tab-content">
 <h2 class="section-title">Налоги, уплаченные в бюджет Москвы</h2>
 {% if taxes %}
 <div class="table-responsive">
 <table>
 <thead>
 <tr>
 <th>Год</th>
 <th>Всего (без акцизов)</th>
 <th>Налог на прибыль</th>
 <th>Налог на имущество</th>
 <th>Налог на землю</th>
 <th>НДФЛ</th>
 <th>Транспортный</th>
 <th>Прочие</th>
 <th>Акцизы</th>
</tr>
</thead>
 <tbody>
 {% for t in taxes %}
 <tr>
 <td><strong>{{ t.year }}</strong></td>
 <td>{{ '{:,.0f}'.format(t.total_taxes_moscow).replace(',', ' ') if t.total_taxes_moscow else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.profit_tax).replace(',', ' ') if t.profit_tax else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.property_tax).replace(',', ' ') if t.property_tax else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.land_tax).replace(',', ' ') if t.land_tax else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.ndfl).replace(',', ' ') if t.ndfl else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.transport_tax).replace(',', ' ') if t.transport_tax else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.other_taxes).replace(',', ' ') if t.other_taxes else '—' }}</td>
 <td>{{ '{:,.0f}'.format(t.excise).replace(',', ' ') if t.excise else '—' }}</td>
</tr>
 {% endfor %}
</tbody>
</table>
</div>
 {% else %}
 <div class="no-data">Налоговые данные отсутствуют</div>
 {% endif %}
</div>

 <!-- Имущество -->
 <div id="assets" class="tab-content">
 <h2 class="section-title">Имущественно-земельный комплекс</h2>
 {% if assets %}
 {% for asset in assets %}
 <div class="info-grid">
 <div class="info-card">
 <div class="info-label">Кадастровый номер ЗУ</div>
 <div class="info-value">{{ asset.cadastral_number_land or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Площадь ЗУ</div>
 <div class="info-value">{{ asset.land_area or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Использование ЗУ</div>
 <div class="info-value">{{ asset.land_usage or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Собственник ЗУ</div>
 <div class="info-value">{{ asset.land_owner or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Кадастровый номер ОКСа</div>
 <div class="info-value">{{ asset.cadastral_number_building or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Площадь ОКСов</div>
 <div class="info-value">{{ asset.building_area or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Тип строения</div>
 <div class="info-value">{{ asset.building_type or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Площадь производственных помещений</div>
 <div class="info-value">{{ asset.production_area or '—' }} кв.м</div>
</div>
</div>
 {% endfor %}
 {% else %}
 <div class="no-data"> Данные об имуществе отсутствуют</div>
 {% endif %}
</div>

 <!-- Продукция -->
 <div id="products" class="tab-content">
 <h2 class="section-title">Производимая продукция</h2>
 {% if products %}
 {% for product in products %}
 <div class="info-grid">
 <div class="info-card">
 <div class="info-label">Производимая продукция</div>
 <div class="info-value">{{ product.product_name or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Коды ОКПД 2</div>
 <div class="info-value">{{ product.okpd2_codes or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Загрузка мощностей</div>
 <div class="info-value">{{ product.capacity_usage or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Наличие экспорта</div>
 <div class="info-value">
 {% if product.has_export %}
 <span class="badge badge-success">Да</span>
 {% else %}
 <span class="badge badge-info">Нет</span>
 {% endif %}
</div>
</div>
 {% if product.has_export %}
 <div class="info-card">
 <div class="info-label">Объем экспорта (прошлый год)</div>
 <div class="info-value">{{ product.export_volume_last_year or '—' }} млн.₽</div>
</div>
 <div class="info-card">
 <div class="info-label">Страны экспорта</div>
 <div class="info-value">{{ product.export_countries or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Код ТН ВЭД ЕАЭС</div>
 <div class="info-value">{{ product.tnved_code or '—' }}</div>
</div>
 {% endif %}
</div>
 {% endfor %}
 {% else %}
 <div class="no-data"> Данные о продукции отсутствуют</div>
 {% endif %}
</div>

 <!-- Контакты -->
 <div id="contacts" class="tab-content">
 <h2 class="section-title">Контактная информация</h2>
 <div class="info-grid">
 <div class="info-card">
 <div class="info-label">Руководитель</div>
 <div class="info-value">{{ org.head_name or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Телефон</div>
 <div class="info-value">{{ org.phone or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Email</div>
 <div class="info-value">{{ org.email or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Сайт</div>
 <div class="info-value">
 {% if org.website %}
 <a href="{{ org.website }}" target="_blank" style="color: var(--accent-dark);">{{ org.website }}</a>
 {% else %}
 —
 {% endif %}
</div>
</div>
 <div class="info-card">
 <div class="info-label">Контакты руководства</div>
 <div class="info-value">{{ org.head_contacts or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Email руководства</div>
 <div class="info-value">{{ org.head_email or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Контакт сотрудника</div>
 <div class="info-value">{{ org.employee_contact or '—' }}</div>
</div>
 <div class="info-card">
 <div class="info-label">Контакт по ЧС</div>
 <div class="info-value">{{ org.emergency_contact or '—' }}</div>
</div>
</div>
</div>
</div>

 <script>
 function showTab(tabName) {
 // Hide all tabs
 const contents = document.querySelectorAll('.tab-content');
 contents.forEach(content => content.classList.remove('active'));

 // Deactivate all tab buttons
 const tabs = document.querySelectorAll('.tab');
 tabs.forEach(tab => tab.classList.remove('active'));

 // Show selected tab
 document.getElementById(tabName).classList.add('active');

 // Activate clicked tab button
 event.target.classList.add('active');
 }

 async function deleteOrganization() {
 if (!confirm('Вы уверены, что хотите удалить эту организацию?\n\nБудут удалены все связанные данные (показатели, налоги, имущество, продукция).\n\nЭто действие нельзя отменить!')) {
 return;
 }

 try {
 const response = await fetch('/organizations/{{ org.id }}', {
 method: 'DELETE'
 });

 if (response.ok) {
 alert('Организация успешно удалена');
 window.location.href = '/organizations';
 } else {
 const error = await response.json();
 alert('Ошибка при удалении: ' + (error.detail || 'Неизвестная ошибка'));
 }
 } catch (error) {
 alert('Ошибка при удалении: ' + error.message);
 }
 }

 async function updateFromFNS() {
 const btn = document.getElementById('fnsBtn');
 const originalText = btn.textContent;
 
 if (!confirm('Обновить данные организации из базы ФНС?\n\nТекущие данные будут перезаписаны актуальной информацией.')) {
 return;
 }

 try {
 // Disable button and show loading state
 btn.disabled = true;
 btn.textContent = '⟳ Загрузка...';

 const response = await fetch('/organizations/{{ org.id }}/update-from-fns', {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json'
 }
 });

 const data = await response.json();

 if (response.ok) {
 alert(data.message + '\n\nОбновленные поля: ' + (data.updated_fields.length > 0 ? data.updated_fields.join(', ') : 'нет изменений'));
 // Reload page to show updated data
 window.location.reload();
 } else {
 alert('Ошибка при обновлении из ФНС: ' + (data.detail || 'Неизвестная ошибка'));
 btn.disabled = false;
 btn.textContent = originalText;
 }
 } catch (error) {
 alert('Ошибка при обновлении из ФНС: ' + error.message);
 btn.disabled = false;
 btn.textContent = originalText;
 }
 }
</script>
</body>
</html>
