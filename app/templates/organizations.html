<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Список организаций - MosProm</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <style>
 .page-header {
 background: var(--card-bg);
 border-bottom: 1px solid var(--border-color);
 padding: 24px;
 margin-bottom: 24px;
 display: flex;
 justify-content: space-between;
 align-items: center;
 }

 .page-title {
 font-size: 24px;
 font-weight: 700;
 color: var(--text-primary);
 }

 .header-actions {
 display: flex;
 gap: 12px;
 }

 .btn {
 padding: 12px 24px;
 border: none;font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 }

 .btn-primary {
 background: var(--card-bg);
 color: var(--accent-dark);
 }

 .btn-primary:hover {box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 }

 .btn-secondary {
 background: rgba(255, 255, 255, 0.2);
 color: var(--card-bg);
 border: 2px solid white;
 }

 .btn-secondary:hover {
 background: rgba(255, 255, 255, 0.3);
 }

 .search-section {
 padding: 30px;
 background: var(--accent-light);
 border-bottom: 1px solid #e9ecef;
 }

 .search-container {
 display: flex;
 gap: 15px;
 max-width: 600px;
 margin-bottom: 20px;
 }

 .search-input {
 flex: 1;
 padding: 12px 20px;
 border: 2px solid #e9ecef;font-size: 14px;
 transition: border-color 0.3s ease;
 }

 .search-input:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .filters-container {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
 gap: 20px;
 }

 .filter-group {
 display: flex;
 flex-direction: column;
 gap: 8px;
 background: var(--card-bg);
 border: 2px solid #e9ecef;padding: 0;
 overflow: hidden;
 }

 .filter-header {
 padding: 12px 15px;
 background: var(--accent-dark);
 cursor: pointer;
 user-select: none;
 transition: background 0.2s ease;
 }

 .filter-header:hover {
 background: var(--accent-dark);
 }

 .filter-label {
 font-size: 13px;
 font-weight: 600;
 color: var(--text-secondary);
 text-transform: uppercase;
 letter-spacing: 0.5px;
 display: flex;
 align-items: center;
 justify-content: space-between;
 }

 .filter-label-left {
 display: flex;
 align-items: center;
 gap: 8px;
 }

 .filter-toggle {
 font-size: 18px;
 transition: transform 0.3s ease;
 }

 .filter-toggle.collapsed {
 transform: rotate(-90deg);
 }

 .filter-count {
 background: var(--accent-dark);
 color: var(--card-bg);
 padding: 2px 8px;font-size: 11px;
 font-weight: 700;
 }

 .filter-content {
 display: flex;
 flex-direction: column;
 gap: 8px;
 padding: 10px;
 max-height: 300px;
 overflow: hidden;
 transition: max-height 0.3s ease, padding 0.3s ease;
 }

 .filter-content.collapsed {
 max-height: 0;
 padding: 0 10px;
 }

 .filter-search {
 padding: 8px 12px;
 border: 1px solid #dee2e6;font-size: 13px;
 width: 100%;
 transition: border-color 0.2s ease;
 }

 .filter-search:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .filter-options {
 max-height: 200px;
 overflow-y: auto;
 display: flex;
 flex-direction: column;
 gap: 8px;
 }

 .filter-options::-webkit-scrollbar {
 width: 6px;
 }

 .filter-options::-webkit-scrollbar-track {
 background: #f1f1f1;}

 .filter-options::-webkit-scrollbar-thumb {
 background: var(--accent-dark);}

 .filter-option {
 display: flex;
 align-items: center;
 gap: 8px;
 cursor: pointer;
 padding: 5px;transition: background 0.2s ease;
 }

 .filter-option:hover {
 background: var(--accent-light);
 }

 .filter-option input[type="checkbox"] {
 width: 18px;
 height: 18px;
 cursor: pointer;
 accent-color: var(--accent-dark);
 }

 .filter-option label {
 flex: 1;
 cursor: pointer;
 font-size: 14px;
 color: var(--text-secondary);
 }

 .filter-option.hidden {
 display: none;
 }

 .no-results {
 padding: 10px;
 text-align: center;
 color: var(--text-secondary);
 font-size: 13px;
 font-style: italic;
 }

 .filter-select {
 padding: 10px 15px;
 border: 2px solid #e9ecef;font-size: 14px;
 background: var(--card-bg);
 cursor: pointer;
 transition: border-color 0.3s ease;
 }

 .filter-select:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .filter-actions {
 display: flex;
 gap: 10px;
 align-items: flex-end;
 }

 .btn-search {
 background: var(--accent-dark);
 color: var(--card-bg);
 padding: 12px 30px;
 }

 .btn-search:hover {
 background: #5568d3;
 }

 .btn-clear {
 background: var(--text-secondary);
 color: var(--card-bg);
 padding: 10px 20px;
 font-size: 14px;
 }

 .btn-clear:hover {
 background: #5a6268;
 }

 .stats {
 padding: 20px 30px;
 background: var(--accent-light);
 color: var(--text-secondary);
 font-size: 14px;
 }

 .active-filters {
 padding: 15px 30px;
 background: #e7f3ff;
 border-bottom: 1px solid #b3d9ff;
 display: flex;
 gap: 10px;
 align-items: center;
 flex-wrap: wrap;
 }

 .active-filters-label {
 font-weight: 600;
 color: #0066cc;
 }

 .filter-tag {
 display: inline-flex;
 align-items: center;
 gap: 8px;
 padding: 6px 12px;
 background: var(--card-bg);
 border: 1px solid #0066cc;color: #0066cc;
 font-size: 13px;
 text-decoration: none;
 transition: all 0.2s ease;
 }

 .filter-tag:hover {
 background: #0066cc;
 color: var(--card-bg);
 }

 .filter-tag-remove {
 font-weight: bold;
 font-size: 14px;
 }

 .table-container {
 padding: 30px;
 overflow-x: auto;
 }

 table {
 width: 100%;
 border-collapse: collapse;
 }

 thead {
 background: var(--accent-light);
 }

 th {
 padding: 15px;
 text-align: left;
 font-weight: 600;
 color: var(--text-secondary);
 border-bottom: 2px solid #dee2e6;
 white-space: nowrap;
 }

 td {
 padding: 15px;
 border-bottom: 1px solid #e9ecef;
 }

 tbody tr {
 transition: background-color 0.2s ease;
 }

 tbody tr:hover {
 background: var(--accent-light);
 }

 .org-name {
 font-weight: 600;
 color: var(--accent-dark);
 text-decoration: none;
 transition: color 0.2s ease;
 }

 .org-name:hover {
 color: #5568d3;
 text-decoration: underline;
 }

 .inn-badge {
 background: #e7f3ff;
 color: #0066cc;
 padding: 4px 12px;font-size: 12px;
 font-weight: 500;
 font-family: 'Courier New', monospace;
 }

 .status-badge {
 padding: 4px 12px;font-size: 12px;
 font-weight: 500;
 }

 .status-active {
 background: #d4edda;
 color: #155724;
 }

 .status-inactive {
 background: #f8d7da;
 color: #721c24;
 }

 .pagination {
 padding: 30px;
 display: flex;
 justify-content: center;
 align-items: center;
 gap: 10px;
 border-top: 1px solid #e9ecef;
 }

 .page-btn {
 padding: 8px 16px;
 border: 1px solid #dee2e6;
 background: var(--card-bg);
 color: var(--text-secondary);cursor: pointer;
 text-decoration: none;
 transition: all 0.2s ease;
 }

 .page-btn:hover:not(.active):not(:disabled) {
 background: var(--accent-light);
 border-color: var(--accent-dark);
 }

 .page-btn.active {
 background: var(--accent-dark);
 color: var(--card-bg);
 border-color: var(--accent-dark);
 }

 .page-btn:disabled {
 opacity: 0.5;
 cursor: not-allowed;
 }

 .empty-state {
 text-align: center;
 padding: 60px 30px;
 color: var(--text-secondary);
 }

 .empty-state-icon {
 font-size: 64px;
 margin-bottom: 20px;
 opacity: 0.3;
 }

 .empty-state h2 {
 font-size: 24px;
 margin-bottom: 10px;
 }

 .empty-state p {
 font-size: 16px;
 }
</style>
</head>
<body>
 <div class="container">
 <div class="header">
 <h1>Реестр промышленных предприятий</h1>
 <div class="header-buttons">
 <a href="/" class="btn btn-secondary">Главная</a>
 <a href="/analytics" class="btn btn-secondary">Аналитика</a>
 <a href="/upload" class="btn btn-primary">Загрузить данные</a>
</div>
</div>

 <div class="search-section">
 <form action="/organizations" method="get">
 <div class="search-container">
 <input 
 type="text" 
 name="search" 
 class="search-input" 
 placeholder="Поиск по названию или ИНН..." 
 value="{{ search }}"
 >
</div>

 <div class="filters-container">
 <!-- Отрасль -->
 <div class="filter-group">
 <div class="filter-header" onclick="toggleFilter('industry')">
 <div class="filter-label">
 <div class="filter-label-left">
 <span class="filter-toggle" id="toggle-industry">▾</span>
 <span>Отрасль</span>
</div>
 {% if selected_industries %}
 <span class="filter-count">{{ selected_industries|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-industry">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск отрасли..." 
 onkeyup="filterOptions('industry', this.value)">
 <div class="filter-options" id="options-industry">
 {% for ind in industries %}
 <div class="filter-option" data-value="{{ ind|lower }}">
 <input type="checkbox" 
 name="industry" 
 value="{{ ind }}" 
 id="industry_{{ loop.index }}"
 {% if ind in selected_industries %}checked{% endif %}>
 <label for="industry_{{ loop.index }}">{{ ind }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-industry" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <!-- Округ -->
 <div class="filter-group">
 <div class="filter-header" onclick="toggleFilter('district')">
 <div class="filter-label">
 <div class="filter-label-left">
 <span class="filter-toggle" id="toggle-district">▾</span>
 <span> Округ</span>
</div>
 {% if selected_districts %}
 <span class="filter-count">{{ selected_districts|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-district">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск округа..." 
 onkeyup="filterOptions('district', this.value)">
 <div class="filter-options" id="options-district">
 {% for dist in districts %}
 <div class="filter-option" data-value="{{ dist|lower }}">
 <input type="checkbox" 
 name="district" 
 value="{{ dist }}" 
 id="district_{{ loop.index }}"
 {% if dist in selected_districts %}checked{% endif %}>
 <label for="district_{{ loop.index }}">{{ dist }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-district" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <!-- Район -->
 <div class="filter-group">
 <div class="filter-header" onclick="toggleFilter('region')">
 <div class="filter-label">
 <div class="filter-label-left">
 <span class="filter-toggle" id="toggle-region">▾</span>
 <span> Район</span>
</div>
 {% if selected_regions %}
 <span class="filter-count">{{ selected_regions|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-region">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск района..." 
 onkeyup="filterOptions('region', this.value)">
 <div class="filter-options" id="options-region">
 {% for reg in regions %}
 <div class="filter-option" data-value="{{ reg|lower }}">
 <input type="checkbox" 
 name="region" 
 value="{{ reg }}" 
 id="region_{{ loop.index }}"
 {% if reg in selected_regions %}checked{% endif %}>
 <label for="region_{{ loop.index }}">{{ reg }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-region" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <!-- Размер -->
 <div class="filter-group">
 <div class="filter-header" onclick="toggleFilter('size')">
 <div class="filter-label">
 <div class="filter-label-left">
 <span class="filter-toggle" id="toggle-size">▾</span>
 <span>Размер</span>
</div>
 {% if selected_sizes %}
 <span class="filter-count">{{ selected_sizes|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-size">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск размера..." 
 onkeyup="filterOptions('size', this.value)">
 <div class="filter-options" id="options-size">
 {% for sz in sizes %}
 <div class="filter-option" data-value="{{ sz|lower }}">
 <input type="checkbox" 
 name="size" 
 value="{{ sz }}" 
 id="size_{{ loop.index }}"
 {% if sz in selected_sizes %}checked{% endif %}>
 <label for="size_{{ loop.index }}">{{ sz }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-size" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <div class="filter-actions">
 <button type="submit" class="btn btn-search"> Применить</button>
 <a href="/organizations" class="btn btn-clear">× Сбросить</a>
</div>
</div>
</form>
</div>

 {% if search or selected_industries or selected_districts or selected_regions or selected_sizes %}
 <div class="active-filters">
 <span class="active-filters-label"> Активные фильтры:</span>
 
 {% if search %}
 {% set params = [] %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Поиск: "{{ search }}" <span class="filter-tag-remove">×</span>
</a>
 {% endif %}

 {% for ind in selected_industries %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for i in selected_industries if i != ind %}{% set _ = params.append('industry=' + i) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Отрасль: {{ ind }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 {% for dist in selected_districts %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for d in selected_districts if d != dist %}{% set _ = params.append('district=' + d) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Округ: {{ dist }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 {% for reg in selected_regions %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for r in selected_regions if r != reg %}{% set _ = params.append('region=' + r) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Район: {{ reg }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 {% for sz in selected_sizes %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for s in selected_sizes if s != sz %}{% set _ = params.append('size=' + s) %}{% endfor %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Размер: {{ sz }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 <a href="/organizations" class="filter-tag" style="border-color: #dc3545; color: #dc3545;">
 <strong>Сбросить все</strong> <span class="filter-tag-remove">×</span>
</a>
</div>
 {% endif %}

 <div class="stats">
 Найдено организаций: <strong>{{ total }}</strong>
</div>

 <div class="table-container">
 {% if organizations %}
 <table>
 <thead>
 <tr>
 <th>Название</th>
 <th>ИНН</th>
 <th>Отрасль</th>
 <th>Статус</th>
 <th>Район</th>
 <th>Размер</th>
</tr>
</thead>
 <tbody>
 {% for org in organizations %}
 <tr>
 <td>
 <a href="/organizations/{{ org.id }}" class="org-name">
 {{ org.name }}
</a>
</td>
 <td>
 <span class="inn-badge">{{ org.inn }}</span>
</td>
 <td>{{ org.main_industry or '—' }}</td>
 <td>
 <span class="status-badge status-active">
 {{ org.status_final or org.status_spark or 'Активно' }}
</span>
</td>
 <td>{{ org.region or org.district or '—' }}</td>
 <td>{{ org.company_size or org.company_size_2022 or '—' }}</td>
</tr>
 {% endfor %}
</tbody>
</table>
 {% else %}
 <div class="empty-state">
 <div class="empty-state-icon"></div>
 <h2>Организации не найдены</h2>
 <p>
 {% if search %}
 По запросу "{{ search }}" ничего не найдено. Попробуйте изменить условия поиска.
 {% else %}
 База данных пуста. Загрузите Excel файл с данными организаций.
 {% endif %}
</p>
</div>
 {% endif %}
</div>

 {% if total_pages > 1 %}
 <div class="pagination">
 {% set query_params = [] %}
 {% if search %}{% set _ = query_params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = query_params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = query_params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = query_params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = query_params.append('size=' + sz) %}{% endfor %}
 {% set query_string = '&' + '&'.join(query_params) if query_params else '' %}

 {% if page > 1 %}
 <a href="/organizations?page={{ page - 1 }}{{ query_string }}" class="page-btn">← Назад</a>
 {% else %}
 <button class="page-btn" disabled>← Назад</button>
 {% endif %}

 {% for p in range(1, total_pages + 1) %}
 {% if p == page %}
 <span class="page-btn active">{{ p }}</span>
 {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
 <a href="/organizations?page={{ p }}{{ query_string }}" class="page-btn">{{ p }}</a>
 {% elif p == page - 3 or p == page + 3 %}
 <span class="page-btn" disabled>...</span>
 {% endif %}
 {% endfor %}

 {% if page < total_pages %}
 <a href="/organizations?page={{ page + 1 }}{{ query_string }}" class="page-btn">Вперёд →</a>
 {% else %}
 <button class="page-btn" disabled>Вперёд →</button>
 {% endif %}
</div>
 {% endif %}
</div>

 <script>
 // Toggle filter visibility
 function toggleFilter(filterName) {
 const content = document.getElementById('content-' + filterName);
 const toggle = document.getElementById('toggle-' + filterName);
 
 if (content.classList.contains('collapsed')) {
 content.classList.remove('collapsed');
 toggle.classList.remove('collapsed');
 } else {
 content.classList.add('collapsed');
 toggle.classList.add('collapsed');
 }
 }

 // Filter options based on search
 function filterOptions(filterName, searchValue) {
 const options = document.getElementById('options-' + filterName);
 const noResults = document.getElementById('no-results-' + filterName);
 const filterOptions = options.querySelectorAll('.filter-option');
 
 searchValue = searchValue.toLowerCase().trim();
 let visibleCount = 0;

 filterOptions.forEach(option => {
 const value = option.getAttribute('data-value');
 if (value.includes(searchValue)) {
 option.classList.remove('hidden');
 visibleCount++;
 } else {
 option.classList.add('hidden');
 }
 });

 // Show/hide "no results" message
 if (visibleCount === 0) {
 noResults.style.display = 'block';
 } else {
 noResults.style.display = 'none';
 }
 }

 // Expand filters that have selected items on page load
 document.addEventListener('DOMContentLoaded', function() {
 const filterNames = ['industry', 'district', 'region', 'size'];
 
 filterNames.forEach(filterName => {
 const content = document.getElementById('content-' + filterName);
 const options = document.getElementById('options-' + filterName);
 const checkedBoxes = options.querySelectorAll('input[type="checkbox"]:checked');
 
 // Keep expanded if there are selected items
 if (checkedBoxes.length > 0) {
 content.classList.remove('collapsed');
 } else {
 // Collapse by default if nothing selected
 content.classList.add('collapsed');
 document.getElementById('toggle-' + filterName).classList.add('collapsed');
 }
 });
 });
</script>
</body>
</html>
