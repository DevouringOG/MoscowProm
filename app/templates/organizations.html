<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Список организаций - MosProm</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
 <style>
 body {
 background: var(--body-bg);
 margin: 0;
 padding: 0;
 }

 /* Page Header */
 .page-header {
 background: var(--card-bg);
 border-bottom: 1px solid var(--border-color);
 padding: 24px;
 margin-bottom: 0;
 display: flex;
 justify-content: space-between;
 align-items: center;
 gap: 24px;
 }

 .header-left {
 display: flex;
 align-items: center;
 gap: 24px;
 }

 .header-logo {
 height: 60px;
 width: auto;
 }

 .page-title-section {
 background: var(--card-bg);
 padding: 20px 30px;
 border-bottom: 1px solid var(--border-color);
 margin-bottom: 0;
 }

 .page-title {
 font-size: 24px;
 font-weight: 700;
 color: var(--text-primary);
 text-transform: uppercase;
 letter-spacing: 0.5px;
 margin: 0;
 }

 .header-actions {
 display: flex;
 gap: 12px;
 }

 .btn-secondary {
 padding: 12px 24px;
 background: transparent;
 color: var(--text-primary);
 border: 2px solid var(--border-color);
 font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 white-space: nowrap;
 }

 .btn-secondary:hover {
 border-color: var(--accent-dark);
 color: var(--accent-dark);
 }

 .filter-actions .btn-secondary {
 min-width: auto;
 }

 .search-section {
 padding: 30px;
 background: var(--accent-light);
 border-bottom: 1px solid #e9ecef;
 }

 .search-container {
 display: flex;
 gap: 15px;
 max-width: 600px;
 margin-bottom: 20px;
 }

 .search-input {
 flex: 1;
 padding: 12px 20px;
 border: 2px solid #e9ecef;font-size: 14px;
 transition: border-color 0.3s ease;
 }

 .search-input:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .filters-container {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
 gap: 20px;
 }

 .filter-group {
 display: flex;
 flex-direction: column;
 gap: 8px;
 background: var(--card-bg);
 border: 2px solid #e9ecef;padding: 0;
 overflow: hidden;
 }

 .filter-header {
 padding: 12px 15px;
 background: var(--accent-dark);
 user-select: none;
 }

 .filter-label {
 font-size: 13px;
 font-weight: 600;
 color: white;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 display: flex;
 align-items: center;
 justify-content: space-between;
 }

 .filter-label-left {
 display: flex;
 align-items: center;
 gap: 8px;
 }

 .toggle-all-btn {
 background: var(--accent-dark);
 color: white;
 border: 2px solid var(--accent-dark);
 padding: 10px 20px;
 font-size: 14px;
 cursor: pointer;
 transition: all 0.3s ease;
 text-transform: uppercase;
 font-weight: 600;
 }

 .toggle-all-btn:hover {
 background: #5568d3;
 border-color: #5568d3;
 }

 .filter-count {
 background: var(--accent-dark);
 color: var(--card-bg);
 padding: 2px 8px;font-size: 11px;
 font-weight: 700;
 }

 .filter-content {
 display: flex;
 flex-direction: column;
 gap: 8px;
 padding: 10px;
 max-height: 300px;
 overflow: hidden;
 transition: max-height 0.3s ease, padding 0.3s ease;
 }

 .filter-content.collapsed {
 max-height: 0;
 padding: 0 10px;
 }

 .filter-search {
 padding: 8px 12px;
 border: 1px solid #dee2e6;font-size: 13px;
 width: 100%;
 transition: border-color 0.2s ease;
 }

 .filter-search:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .filter-options {
 max-height: 200px;
 overflow-y: auto;
 display: flex;
 flex-direction: column;
 gap: 8px;
 }

 .filter-options::-webkit-scrollbar {
 width: 6px;
 }

 .filter-options::-webkit-scrollbar-track {
 background: #f1f1f1;}

 .filter-options::-webkit-scrollbar-thumb {
 background: var(--accent-dark);}

 .filter-option {
 display: flex;
 align-items: center;
 gap: 8px;
 cursor: pointer;
 padding: 5px;transition: background 0.2s ease;
 }

 .filter-option:hover {
 background: var(--accent-light);
 }

 .filter-option input[type="checkbox"] {
 width: 18px;
 height: 18px;
 cursor: pointer;
 accent-color: var(--accent-dark);
 }

 .filter-option label {
 flex: 1;
 cursor: pointer;
 font-size: 14px;
 color: var(--text-secondary);
 }

 .filter-option.hidden {
 display: none;
 }

 .no-results {
 padding: 10px;
 text-align: center;
 color: var(--text-secondary);
 font-size: 13px;
 font-style: italic;
 }

 .filter-select {
 padding: 10px 15px;
 border: 2px solid #e9ecef;font-size: 14px;
 background: var(--card-bg);
 cursor: pointer;
 transition: border-color 0.3s ease;
 }

 .filter-select:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .filter-actions {
 display: flex;
 gap: 10px;
 align-items: center;
 margin-top: 20px;
 }

 .btn-primary {
 padding: 12px 24px;
 background: var(--accent-dark);
 color: white;
 border: 2px solid var(--accent-dark);
 font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 white-space: nowrap;
 }

 .btn-primary:hover {
 background: #5568d3;
 border-color: #5568d3;
 }

 .sort-controls {
 display: flex;
 gap: 8px;
 align-items: center;
 margin-left: auto;
 }

 .sort-label {
 font-size: 14px;
 font-weight: 600;
 color: var(--text-secondary);
 }

 .sort-select {
 padding: 10px 15px;
 border: 2px solid #e9ecef;
 font-size: 14px;
 background: var(--card-bg);
 cursor: pointer;
 transition: border-color 0.3s ease;
 }

 .sort-select:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .sort-order-select {
 padding: 10px 15px;
 border: 2px solid #e9ecef;
 font-size: 14px;
 background: var(--card-bg);
 cursor: pointer;
 transition: border-color 0.3s ease;
 }

 .sort-order-select:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .btn-search {
 background: var(--accent-dark);
 color: white;
 border: 2px solid var(--accent-dark);
 padding: 12px 30px;
 font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 }

 .btn-search:hover {
 background: #5568d3;
 border-color: #5568d3;
 }

 .stats {
 padding: 20px 30px;
 background: var(--accent-light);
 color: var(--text-secondary);
 font-size: 14px;
 }

 .active-filters {
 padding: 15px 30px;
 background: rgba(70, 80, 100, 0.3);
 border-bottom: 1px solid var(--border-color);
 display: flex;
 gap: 10px;
 align-items: center;
 flex-wrap: wrap;
 }

 .active-filters-label {
 font-weight: 600;
 color: var(--text-primary);
 }

 .filter-tag {
 display: inline-flex;
 align-items: center;
 gap: 8px;
 padding: 6px 12px;
 background: var(--card-bg);
 border: 1px solid var(--border-color);
 color: var(--text-primary);
 font-size: 13px;
 text-decoration: none;
 transition: all 0.2s ease;
 }

 .filter-tag:hover {
 background: var(--accent-dark);
 color: white;
 border-color: var(--accent-dark);
 }

 .filter-tag-remove {
 font-weight: bold;
 font-size: 14px;
 }

 .table-container {
 padding: 30px;
 overflow-x: auto;
 }

 table {
 width: 100%;
 border-collapse: collapse;
 }

 thead {
 background: var(--accent-light);
 }

 th {
 padding: 15px;
 text-align: left;
 font-weight: 600;
 color: var(--text-secondary);
 border-bottom: 2px solid #dee2e6;
 white-space: nowrap;
 }

 td {
 padding: 15px;
 border-bottom: 1px solid #e9ecef;
 }

 tbody tr {
 transition: background-color 0.2s ease;
 }

 tbody tr:hover {
 background: var(--accent-light);
 }

 .org-name {
 font-weight: 600;
 color: var(--accent-dark);
 text-decoration: none;
 transition: color 0.2s ease;
 }

 .org-name:hover {
 color: #5568d3;
 text-decoration: underline;
 }

 .inn-badge {
 background: #e7f3ff;
 color: #0066cc;
 padding: 4px 12px;font-size: 12px;
 font-weight: 500;
 font-family: 'Courier New', monospace;
 }

 .status-badge {
 padding: 4px 12px;font-size: 12px;
 font-weight: 500;
 }

 .status-active {
 background: #d4edda;
 color: #155724;
 }

 .status-inactive {
 background: #f8d7da;
 color: #721c24;
 }

 .pagination {
 padding: 30px;
 display: flex;
 justify-content: center;
 align-items: center;
 gap: 10px;
 border-top: 1px solid #e9ecef;
 }

 .page-btn {
 padding: 8px 16px;
 border: 1px solid #dee2e6;
 background: var(--card-bg);
 color: var(--text-secondary);cursor: pointer;
 text-decoration: none;
 transition: all 0.2s ease;
 }

 .page-btn:hover:not(.active):not(:disabled) {
 background: var(--accent-light);
 border-color: var(--accent-dark);
 }

 .page-btn.active {
 background: var(--accent-dark);
 color: var(--card-bg);
 border-color: var(--accent-dark);
 }

 .page-btn:disabled {
 opacity: 0.5;
 cursor: not-allowed;
 }

 .empty-state {
 text-align: center;
 padding: 60px 30px;
 color: var(--text-secondary);
 }

 .empty-state-icon {
 font-size: 64px;
 margin-bottom: 20px;
 opacity: 0.3;
 }

 .empty-state h2 {
 font-size: 24px;
 margin-bottom: 10px;
 }

 .empty-state p {
 font-size: 16px;
 }

 /* Column Settings Button */
 .column-settings-btn {
 background: transparent;
 border: none;
 cursor: pointer;
 padding: 8px;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 transition: all 0.3s ease;
 }

 .column-settings-btn:hover {
 background: rgba(0, 0, 0, 0.05);
 }

 .column-settings-btn svg {
 width: 20px;
 height: 20px;
 fill: var(--text-secondary);
 }

 /* Modal Overlay */
 .modal-overlay {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background: rgba(0, 0, 0, 0.5);
 z-index: 9998;
 }

 .modal-overlay.active {
 display: block;
 }

 /* Column Settings Modal */
 .column-settings-modal {
 display: none;
 position: fixed;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 background: white;
 border-radius: 8px;
 box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
 z-index: 9999;
 width: 90%;
 max-width: 600px;
 max-height: 80vh;
 overflow: hidden;
 flex-direction: column;
 }

 .column-settings-modal.active {
 display: flex;
 }

 .modal-header {
 padding: 20px 24px;
 border-bottom: 1px solid #e0e0e0;
 display: flex;
 justify-content: space-between;
 align-items: center;
 }

 .modal-header h2 {
 margin: 0;
 font-size: 20px;
 font-weight: 600;
 color: var(--text-primary);
 }

 .modal-close {
 background: none;
 border: none;
 font-size: 24px;
 cursor: pointer;
 color: var(--text-secondary);
 padding: 0;
 width: 32px;
 height: 32px;
 display: flex;
 align-items: center;
 justify-content: center;
 border-radius: 4px;
 transition: background 0.2s;
 }

 .modal-close:hover {
 background: rgba(0, 0, 0, 0.05);
 }

 .modal-body {
 padding: 20px;
 display: flex;
 flex-direction: column;
 gap: 16px;
 overflow-y: hidden;
 flex: 1;
 }

 .column-list {
 list-style: none;
 padding: 0;
 margin: 0;
 max-height: 400px;
 overflow-y: auto;
 padding-right: 8px;
 }

 .column-list::-webkit-scrollbar {
 width: 8px;
 }

 .column-list::-webkit-scrollbar-track {
 background: #f1f1f1;
 border-radius: 4px;
 }

 .column-list::-webkit-scrollbar-thumb {
 background: #888;
 border-radius: 4px;
 }

 .column-list::-webkit-scrollbar-thumb:hover {
 background: #555;
 }

 .column-item {
 display: flex;
 align-items: center;
 padding: 12px 16px;
 background: #f8f9fa;
 margin-bottom: 8px;
 border-radius: 6px;
 cursor: move;
 transition: all 0.2s;
 border: 1px solid transparent;
 }

 .column-item:hover {
 background: #e9ecef;
 box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
 }

 .column-item.sortable-ghost {
 opacity: 0.4;
 background: #dee2e6;
 }

 .column-item.sortable-drag {
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
 }

 .drag-handle {
 margin-right: 12px;
 color: #6c757d;
 cursor: grab;
 display: flex;
 flex-direction: column;
 gap: 2px;
 }

 .drag-handle:active {
 cursor: grabbing;
 }

 .drag-handle span {
 width: 18px;
 height: 2px;
 background: currentColor;
 border-radius: 1px;
 }

 .column-checkbox {
 margin-right: 12px;
 width: 18px;
 height: 18px;
 cursor: pointer;
 }

 .column-label {
 flex: 1;
 font-size: 14px;
 font-weight: 500;
 color: var(--text-primary);
 cursor: pointer;
 }

 .modal-actions {
 display: flex;
 justify-content: space-between;
 align-items: center;
 gap: 12px;
 padding-top: 16px;
 border-top: 1px solid #e0e0e0;
 margin-top: auto;
 }

 .modal-actions-right {
 display: flex;
 gap: 12px;
 }

 .btn-reset {
 padding: 10px 20px;
 background: transparent;
 color: #6c757d;
 border: 1px solid #dee2e6;
 border-radius: 4px;
 cursor: pointer;
 font-size: 14px;
 font-weight: 500;
 transition: all 0.2s;
 }

 .btn-reset:hover {
 background: #f8f9fa;
 border-color: #adb5bd;
 }

 .btn-cancel {
 padding: 10px 20px;
 background: transparent;
 color: var(--text-primary);
 border: 1px solid #dee2e6;
 border-radius: 4px;
 cursor: pointer;
 font-size: 14px;
 font-weight: 500;
 transition: all 0.2s;
 }

 .btn-cancel:hover {
 background: #f8f9fa;
 }

 .btn-apply {
 padding: 10px 24px;
 background: var(--accent-dark);
 color: white;
 border: none;
 border-radius: 4px;
 cursor: pointer;
 font-size: 14px;
 font-weight: 500;
 transition: all 0.2s;
 }

 .btn-apply:hover {
 background: #5568d3;
 }

 /* Hide columns dynamically */
 .column-hidden {
 display: none !important;
 }
</style>
</head>
<body>
 <div class="page-header">
 <div class="header-left">
 <img src="/static/logo.svg" alt="MosProm" class="header-logo">
 </div>
 <div class="header-actions">
 <a href="/analytics" class="btn-secondary">АНАЛИТИКА</a>
 <a href="/organizations/create" class="btn-secondary">ДОБАВИТЬ</a>
 <a href="/upload" class="btn-secondary">ЗАГРУЗКА</a>
 </div>
 </div>

 <div class="container">

 <div class="page-title-section">
 <h1 class="page-title">СПИСОК ПРЕДПРИЯТИЙ</h1>
 </div>

 <div class="search-section">
 <form action="/organizations" method="get">
 <div class="search-container">
 <input 
 type="text" 
 name="search" 
 class="search-input" 
 placeholder="Поиск по названию или ИНН..." 
 value="{{ search }}"
 >
 <button type="submit" class="btn btn-search">Поиск</button>
</div>

 <div class="filters-container">
 <!-- Отрасль -->
 <div class="filter-group">
 <div class="filter-header">
 <div class="filter-label">
 <div class="filter-label-left">
 <span>Отрасль</span>
</div>
 {% if selected_industries %}
 <span class="filter-count">{{ selected_industries|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-industry">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск отрасли..." 
 onkeyup="filterOptions('industry', this.value)">
 <div class="filter-options" id="options-industry">
 {% for ind in industries %}
 <div class="filter-option" data-value="{{ ind|lower }}">
 <input type="checkbox" 
 name="industry" 
 value="{{ ind }}" 
 id="industry_{{ loop.index }}"
 {% if ind in selected_industries %}checked{% endif %}>
 <label for="industry_{{ loop.index }}">{{ ind }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-industry" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <!-- Округ -->
 <div class="filter-group">
 <div class="filter-header">
 <div class="filter-label">
 <div class="filter-label-left">
 <span> Округ</span>
</div>
 {% if selected_districts %}
 <span class="filter-count">{{ selected_districts|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-district">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск округа..." 
 onkeyup="filterOptions('district', this.value)">
 <div class="filter-options" id="options-district">
 {% for dist in districts %}
 <div class="filter-option" data-value="{{ dist|lower }}">
 <input type="checkbox" 
 name="district" 
 value="{{ dist }}" 
 id="district_{{ loop.index }}"
 {% if dist in selected_districts %}checked{% endif %}>
 <label for="district_{{ loop.index }}">{{ dist }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-district" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <!-- Район -->
 <div class="filter-group">
 <div class="filter-header">
 <div class="filter-label">
 <div class="filter-label-left">
 <span> Район</span>
</div>
 {% if selected_regions %}
 <span class="filter-count">{{ selected_regions|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-region">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск района..." 
 onkeyup="filterOptions('region', this.value)">
 <div class="filter-options" id="options-region">
 {% for reg in regions %}
 <div class="filter-option" data-value="{{ reg|lower }}">
 <input type="checkbox" 
 name="region" 
 value="{{ reg }}" 
 id="region_{{ loop.index }}"
 {% if reg in selected_regions %}checked{% endif %}>
 <label for="region_{{ loop.index }}">{{ reg }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-region" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <!-- Размер -->
 <div class="filter-group">
 <div class="filter-header">
 <div class="filter-label">
 <div class="filter-label-left">
 <span>Размер</span>
</div>
 {% if selected_sizes %}
 <span class="filter-count">{{ selected_sizes|length }}</span>
 {% endif %}
</div>
</div>
 <div class="filter-content" id="content-size">
 <input type="text" 
 class="filter-search" 
 placeholder=" Поиск размера..." 
 onkeyup="filterOptions('size', this.value)">
 <div class="filter-options" id="options-size">
 {% for sz in sizes %}
 <div class="filter-option" data-value="{{ sz|lower }}">
 <input type="checkbox" 
 name="size" 
 value="{{ sz }}" 
 id="size_{{ loop.index }}"
 {% if sz in selected_sizes %}checked{% endif %}>
 <label for="size_{{ loop.index }}">{{ sz }}</label>
</div>
 {% endfor %}
</div>
 <div class="no-results" id="no-results-size" style="display: none;">
 Ничего не найдено
</div>
</div>
</div>

 <div class="filter-actions">
 <button type="submit" class="btn-primary">Применить фильтры</button>
 <a href="/organizations" class="btn-secondary">Сбросить</a>
 <button type="button" class="btn-secondary" onclick="toggleAllFilters()" id="toggleAllBtn">Скрыть все фильтры</button>
 <button type="button" class="btn-secondary" onclick="exportToExcel()">Выгрузить в Excel</button>
 
 <div class="sort-controls">
 <span class="sort-label">Сортировка:</span>
 <select name="sort_by" class="sort-select" onchange="this.form.submit()">
 <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Название</option>
 <option value="inn" {% if sort_by == 'inn' %}selected{% endif %}>ИНН</option>
 <option value="main_industry" {% if sort_by == 'main_industry' %}selected{% endif %}>Отрасль</option>
 <option value="status_final" {% if sort_by == 'status_final' %}selected{% endif %}>Статус</option>
 <option value="district" {% if sort_by == 'district' %}selected{% endif %}>Округ</option>
 <option value="region" {% if sort_by == 'region' %}selected{% endif %}>Район</option>
 <option value="company_size" {% if sort_by == 'company_size' %}selected{% endif %}>Размер</option>
 </select>
 <select name="order" class="sort-order-select" onchange="this.form.submit()">
 <option value="asc" {% if order == 'asc' %}selected{% endif %}>По возрастанию</option>
 <option value="desc" {% if order == 'desc' %}selected{% endif %}>По убыванию</option>
 </select>
 </div>
 </div>
</div>
</form>
</div>

 {% if search or selected_industries or selected_districts or selected_regions or selected_sizes %}
 <div class="active-filters">
 <span class="active-filters-label"> Активные фильтры:</span>
 
 {% if search %}
 {% set params = [] %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 {% set _ = params.append('sort_by=' + sort_by) %}
 {% set _ = params.append('order=' + order) %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Поиск: "{{ search }}" <span class="filter-tag-remove">×</span>
</a>
 {% endif %}

 {% for ind in selected_industries %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for i in selected_industries if i != ind %}{% set _ = params.append('industry=' + i) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 {% set _ = params.append('sort_by=' + sort_by) %}
 {% set _ = params.append('order=' + order) %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Отрасль: {{ ind }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 {% for dist in selected_districts %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for d in selected_districts if d != dist %}{% set _ = params.append('district=' + d) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 {% set _ = params.append('sort_by=' + sort_by) %}
 {% set _ = params.append('order=' + order) %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Округ: {{ dist }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 {% for reg in selected_regions %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for r in selected_regions if r != reg %}{% set _ = params.append('region=' + r) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = params.append('size=' + sz) %}{% endfor %}
 {% set _ = params.append('sort_by=' + sort_by) %}
 {% set _ = params.append('order=' + order) %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Район: {{ reg }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}

 {% for sz in selected_sizes %}
 {% set params = [] %}
 {% if search %}{% set _ = params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = params.append('region=' + reg) %}{% endfor %}
 {% for s in selected_sizes if s != sz %}{% set _ = params.append('size=' + s) %}{% endfor %}
 {% set _ = params.append('sort_by=' + sort_by) %}
 {% set _ = params.append('order=' + order) %}
 <a href="/organizations?{{ '&'.join(params) }}" class="filter-tag">
 Размер: {{ sz }} <span class="filter-tag-remove">×</span>
</a>
 {% endfor %}
</div>
 {% endif %}

 <div class="stats">
 Найдено организаций: <strong>{{ total }}</strong>
</div>

 <div class="table-container">
 {% if organizations %}
 <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
 <button class="column-settings-btn" onclick="openColumnSettings()" title="Настроить столбцы">
 <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
 <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65c-.04-.24-.25-.42-.5-.42h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z"/>
 </svg>
 </button>
 </div>
 <table id="organizationsTable">
 <thead>
 <tr id="tableHeader">
 <th data-column="name">Название</th>
 <th data-column="inn">ИНН</th>
 <th data-column="industry">Отрасль</th>
 <th data-column="subindustry">Подотрасль</th>
 <th data-column="status">Статус</th>
 <th data-column="district">Округ</th>
 <th data-column="region">Район</th>
 <th data-column="size">Размер</th>
 <th data-column="msp_status">Статус МСП</th>
 <th data-column="okved">ОКВЭД</th>
 <th data-column="reg_date">Дата регистрации</th>
 <th data-column="head">Руководитель</th>
 <th data-column="phone">Телефон</th>
 <th data-column="email">Email</th>
 <th data-column="website">Сайт</th>
 <th data-column="address">Адрес</th>
 <th data-column="employees">Численность</th>
 <th data-column="revenue">Выручка</th>
 <th data-column="profit">Прибыль</th>
 <th data-column="system_critical">Системообразующая</th>
</tr>
</thead>
 <tbody>
 {% for org in organizations %}
 <tr>
 <td data-column="name">
 <a href="/organizations/{{ org.id }}" class="org-name">
 {{ org.name }}
</a>
</td>
 <td data-column="inn">
 <span class="inn-badge">{{ org.inn }}</span>
</td>
 <td data-column="industry">{{ org.main_industry or '—' }}</td>
 <td data-column="subindustry">{{ org.main_subindustry or '—' }}</td>
 <td data-column="status">
 <span class="status-badge status-active">
 {{ org.status_final or org.status_spark or 'Активно' }}
</span>
</td>
 <td data-column="district">{{ org.district or '—' }}</td>
 <td data-column="region">{{ org.region or '—' }}</td>
 <td data-column="size">{{ org.company_size or org.company_size_2022 or '—' }}</td>
 <td data-column="msp_status">{{ org.msp_status or '—' }}</td>
 <td data-column="okved">{{ org.main_okved or '—' }}</td>
 <td data-column="reg_date">{{ org.registration_date.strftime('%d.%m.%Y') if org.registration_date else '—' }}</td>
 <td data-column="head">{{ org.head_name or '—' }}</td>
 <td data-column="phone">{{ org.phone or '—' }}</td>
 <td data-column="email">{{ org.email or '—' }}</td>
 <td data-column="website">
 {% if org.website %}
 <a href="{{ org.website }}" target="_blank">{{ org.website[:30] }}...</a>
 {% else %}
 —
 {% endif %}
</td>
 <td data-column="address">{{ org.legal_address or '—' }}</td>
 <td data-column="employees">
 {% if org.metrics %}
 {{ org.metrics[-1].total_employees or '—' }}
 {% else %}
 —
 {% endif %}
</td>
 <td data-column="revenue">
 {% if org.metrics %}
 {{ '{:,.0f}'.format(org.metrics[-1].revenue).replace(',', ' ') if org.metrics[-1].revenue else '—' }}
 {% else %}
 —
 {% endif %}
</td>
 <td data-column="profit">
 {% if org.metrics %}
 {{ '{:,.0f}'.format(org.metrics[-1].profit).replace(',', ' ') if org.metrics[-1].profit else '—' }}
 {% else %}
 —
 {% endif %}
</td>
 <td data-column="system_critical">
 {% if org.is_system_critical %}
 <span class="badge badge-success">Да</span>
 {% else %}
 —
 {% endif %}
</td>
</tr>
 {% endfor %}
</tbody>
</table>
 {% else %}
 <div class="empty-state">
 <div class="empty-state-icon"></div>
 <h2>Организации не найдены</h2>
 <p>
 {% if search %}
 По запросу "{{ search }}" ничего не найдено. Попробуйте изменить условия поиска.
 {% else %}
 База данных пуста.
 {% endif %}
</p>
</div>
 {% endif %}
</div>

 {% if total_pages > 1 %}
 <div class="pagination">
 {% set query_params = [] %}
 {% if search %}{% set _ = query_params.append('search=' + search) %}{% endif %}
 {% for ind in selected_industries %}{% set _ = query_params.append('industry=' + ind) %}{% endfor %}
 {% for dist in selected_districts %}{% set _ = query_params.append('district=' + dist) %}{% endfor %}
 {% for reg in selected_regions %}{% set _ = query_params.append('region=' + reg) %}{% endfor %}
 {% for sz in selected_sizes %}{% set _ = query_params.append('size=' + sz) %}{% endfor %}
 {% set _ = query_params.append('sort_by=' + sort_by) %}
 {% set _ = query_params.append('order=' + order) %}
 {% set query_string = '&' + '&'.join(query_params) if query_params else '' %}

 {% if page > 1 %}
 <a href="/organizations?page={{ page - 1 }}{{ query_string }}" class="page-btn">← Назад</a>
 {% else %}
 <button class="page-btn" disabled>← Назад</button>
 {% endif %}

 {% for p in range(1, total_pages + 1) %}
 {% if p == page %}
 <span class="page-btn active">{{ p }}</span>
 {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
 <a href="/organizations?page={{ p }}{{ query_string }}" class="page-btn">{{ p }}</a>
 {% elif p == page - 3 or p == page + 3 %}
 <span class="page-btn" disabled>...</span>
 {% endif %}
 {% endfor %}

 {% if page < total_pages %}
 <a href="/organizations?page={{ page + 1 }}{{ query_string }}" class="page-btn">Вперёд →</a>
 {% else %}
 <button class="page-btn" disabled>Вперёд →</button>
 {% endif %}
</div>
 {% endif %}
</div>

 <script>
 let filtersOpen = true;

 // Toggle all filters at once
 function toggleAllFilters() {
 const filterNames = ['industry', 'district', 'region', 'size'];
 const btn = document.getElementById('toggleAllBtn');
 
 filterNames.forEach(filterName => {
 const content = document.getElementById('content-' + filterName);
 
 if (filtersOpen) {
 content.classList.add('collapsed');
 } else {
 content.classList.remove('collapsed');
 }
 });
 
 filtersOpen = !filtersOpen;
 btn.textContent = filtersOpen ? 'Скрыть все фильтры' : 'Показать все фильтры';
 }

 // Filter options based on search
 function filterOptions(filterName, searchValue) {
 const options = document.getElementById('options-' + filterName);
 const noResults = document.getElementById('no-results-' + filterName);
 const filterOptions = options.querySelectorAll('.filter-option');
 
 searchValue = searchValue.toLowerCase().trim();
 let visibleCount = 0;

 filterOptions.forEach(option => {
 const value = option.getAttribute('data-value');
 if (value.includes(searchValue)) {
 option.classList.remove('hidden');
 visibleCount++;
 } else {
 option.classList.add('hidden');
 }
 });

 // Show/hide "no results" message
 if (visibleCount === 0) {
 noResults.style.display = 'block';
 } else {
 noResults.style.display = 'none';
 }
 }

 // Keep all filters open on page load
 document.addEventListener('DOMContentLoaded', function() {
 const filterNames = ['industry', 'district', 'region', 'size'];
 
 filterNames.forEach(filterName => {
 const content = document.getElementById('content-' + filterName);
 content.classList.remove('collapsed');
 });
 });

 // Export to Excel function
 function exportToExcel() {
 // Build URL with current filters
 const params = new URLSearchParams();
 
 // Add search parameter
 const searchInput = document.querySelector('input[name="search"]');
 if (searchInput && searchInput.value) {
 params.append('search', searchInput.value);
 }
 
 // Add industry filters
 document.querySelectorAll('input[name="industry"]:checked').forEach(checkbox => {
 params.append('industry', checkbox.value);
 });
 
 // Add district filters
 document.querySelectorAll('input[name="district"]:checked').forEach(checkbox => {
 params.append('district', checkbox.value);
 });
 
 // Add region filters
 document.querySelectorAll('input[name="region"]:checked').forEach(checkbox => {
 params.append('region', checkbox.value);
 });
 
 // Add size filters
 document.querySelectorAll('input[name="size"]:checked').forEach(checkbox => {
 params.append('size', checkbox.value);
 });
 
 // Add sort parameters
 const sortBySelect = document.querySelector('select[name="sort_by"]');
 const orderSelect = document.querySelector('select[name="order"]');
 if (sortBySelect) {
 params.append('sort_by', sortBySelect.value);
 }
 if (orderSelect) {
 params.append('order', orderSelect.value);
 }
 
 // Open export URL in new window to download file
 const exportUrl = '/organizations/export?' + params.toString();
 window.location.href = exportUrl;
 }

 // === Column Customization Feature ===

 // Default visible columns (6 currently visible)
 const DEFAULT_COLUMNS = ['name', 'inn', 'industry', 'status', 'region', 'size'];

 // All available columns
 const ALL_COLUMNS = [
 { id: 'name', label: 'Название' },
 { id: 'inn', label: 'ИНН' },
 { id: 'industry', label: 'Отрасль' },
 { id: 'subindustry', label: 'Подотрасль' },
 { id: 'status', label: 'Статус' },
 { id: 'district', label: 'Округ' },
 { id: 'region', label: 'Район' },
 { id: 'size', label: 'Размер' },
 { id: 'msp_status', label: 'Статус МСП' },
 { id: 'okved', label: 'ОКВЭД' },
 { id: 'reg_date', label: 'Дата регистрации' },
 { id: 'head', label: 'Руководитель' },
 { id: 'phone', label: 'Телефон' },
 { id: 'email', label: 'Email' },
 { id: 'website', label: 'Сайт' },
 { id: 'address', label: 'Адрес' },
 { id: 'employees', label: 'Численность' },
 { id: 'revenue', label: 'Выручка' },
 { id: 'profit', label: 'Прибыль' },
 { id: 'system_critical', label: 'Системообразующая' }
];

 let sortable = null;

 // Load column settings from localStorage
 function loadColumnSettings() {
 const saved = localStorage.getItem('organizationColumns');
 if (saved) {
 try {
 const settings = JSON.parse(saved);
 return {
 visible: settings.visible || DEFAULT_COLUMNS,
 order: settings.order || ALL_COLUMNS.map(c => c.id)
 };
 } catch (e) {
 console.error('Failed to parse column settings:', e);
 }
 }
 return {
 visible: DEFAULT_COLUMNS,
 order: ALL_COLUMNS.map(c => c.id)
 };
 }

 // Save column settings to localStorage
 function saveColumnSettings(visible, order) {
 localStorage.setItem('organizationColumns', JSON.stringify({ visible, order }));
 }

 // Apply column visibility to table
 function applyColumnVisibility(visibleColumns) {
 const table = document.getElementById('organizationsTable');
 const headers = table.querySelectorAll('thead th[data-column]');
 const rows = table.querySelectorAll('tbody tr');

 // Hide/show headers
 headers.forEach(th => {
 const column = th.getAttribute('data-column');
 if (visibleColumns.includes(column)) {
 th.classList.remove('column-hidden');
 } else {
 th.classList.add('column-hidden');
 }
 });

 // Hide/show cells
 rows.forEach(row => {
 const cells = row.querySelectorAll('td[data-column]');
 cells.forEach(td => {
 const column = td.getAttribute('data-column');
 if (visibleColumns.includes(column)) {
 td.classList.remove('column-hidden');
 } else {
 td.classList.add('column-hidden');
 }
 });
 });
 }

 // Reorder columns in table
 function applyColumnOrder(order) {
 const table = document.getElementById('organizationsTable');
 const headerRow = document.getElementById('tableHeader');
 const rows = table.querySelectorAll('tbody tr');

 // Create a map of column elements
 const headerMap = new Map();
 headerRow.querySelectorAll('th[data-column]').forEach(th => {
 headerMap.set(th.getAttribute('data-column'), th);
 });

 // Reorder headers
 const fragment = document.createDocumentFragment();
 order.forEach(colId => {
 if (headerMap.has(colId)) {
 fragment.appendChild(headerMap.get(colId));
 }
 });
 headerRow.innerHTML = '';
 headerRow.appendChild(fragment);

 // Reorder cells in each row
 rows.forEach(row => {
 const cellMap = new Map();
 row.querySelectorAll('td[data-column]').forEach(td => {
 cellMap.set(td.getAttribute('data-column'), td);
 });

 const rowFragment = document.createDocumentFragment();
 order.forEach(colId => {
 if (cellMap.has(colId)) {
 rowFragment.appendChild(cellMap.get(colId));
 }
 });
 row.innerHTML = '';
 row.appendChild(rowFragment);
 });
 }

 // Open column settings modal
 function openColumnSettings() {
 const modal = document.getElementById('columnSettingsModal');
 const overlay = document.getElementById('columnModalOverlay');
 const columnList = document.getElementById('columnList');

 // Load current settings
 const settings = loadColumnSettings();

 // Build column list
 columnList.innerHTML = '';
 settings.order.forEach(colId => {
 const column = ALL_COLUMNS.find(c => c.id === colId);
 if (!column) return;

 const li = document.createElement('li');
 li.className = 'column-item';
 li.setAttribute('data-column', column.id);

 const isVisible = settings.visible.includes(column.id);

 li.innerHTML = `
 <div class="drag-handle">
 <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
 <circle cx="4" cy="3" r="1" fill="currentColor"/>
 <circle cx="12" cy="3" r="1" fill="currentColor"/>
 <circle cx="4" cy="8" r="1" fill="currentColor"/>
 <circle cx="12" cy="8" r="1" fill="currentColor"/>
 <circle cx="4" cy="13" r="1" fill="currentColor"/>
 <circle cx="12" cy="13" r="1" fill="currentColor"/>
</svg>
</div>
 <input type="checkbox" class="column-checkbox" id="col-${column.id}" ${isVisible ? 'checked' : ''}>
 <label class="column-label" for="col-${column.id}">${column.label}</label>
 `;

 columnList.appendChild(li);
 });

 // Initialize sortable
 if (sortable) {
 sortable.destroy();
 }
 sortable = Sortable.create(columnList, {
 handle: '.drag-handle',
 animation: 150,
 ghostClass: 'sortable-ghost'
 });

 // Show modal
 overlay.style.display = 'block';
 modal.style.display = 'block';
 }

 // Close column settings modal
 function closeColumnSettings() {
 const modal = document.getElementById('columnSettingsModal');
 const overlay = document.getElementById('columnModalOverlay');

 overlay.style.display = 'none';
 modal.style.display = 'none';

 if (sortable) {
 sortable.destroy();
 sortable = null;
 }
 }

 // Apply column settings
 function applyColumnSettings() {
 const columnList = document.getElementById('columnList');
 const items = columnList.querySelectorAll('.column-item');

 // Get new order
 const order = Array.from(items).map(item => item.getAttribute('data-column'));

 // Get visible columns
 const visible = [];
 items.forEach(item => {
 const colId = item.getAttribute('data-column');
 const checkbox = item.querySelector('.column-checkbox');
 if (checkbox.checked) {
 visible.push(colId);
 }
 });

 // Save settings
 saveColumnSettings(visible, order);

 // Apply to table
 applyColumnOrder(order);
 applyColumnVisibility(visible);

 // Close modal
 closeColumnSettings();
 }

 // Reset to default columns
 function resetColumns() {
 const defaultOrder = ALL_COLUMNS.map(c => c.id);
 saveColumnSettings(DEFAULT_COLUMNS, defaultOrder);
 applyColumnOrder(defaultOrder);
 applyColumnVisibility(DEFAULT_COLUMNS);
 closeColumnSettings();
 }

 // Initialize on page load
 document.addEventListener('DOMContentLoaded', function() {
 const settings = loadColumnSettings();
 applyColumnOrder(settings.order);
 applyColumnVisibility(settings.visible);
 });
</script>

 <!-- Column Settings Modal -->
 <div class="modal-overlay" id="columnModalOverlay" onclick="closeColumnSettings()"></div>
 <div class="column-settings-modal" id="columnSettingsModal">
 <div class="modal-header">
 <h3>Настройка столбцов</h3>
 <button onclick="closeColumnSettings()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
</div>
 <div class="modal-body">
 <ul class="column-list" id="columnList"></ul>
 <div class="modal-actions">
 <button class="btn-reset" onclick="resetColumns()">Сбросить</button>
 <div class="modal-actions-right">
 <button class="btn-cancel" onclick="closeColumnSettings()">Отмена</button>
 <button class="btn-apply" onclick="applyColumnSettings()">Применить</button>
</div>
</div>
</div>
</div>
</body>
</html>
