<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Загрузка данных предприятий</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <style>
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
 background: var(--accent-dark);
 min-height: 100vh;
 display: flex;
 align-items: center;
 justify-content: center;
 padding: 20px;
 }

 .container {
 background: var(--card-bg);
 box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 max-width: 1200px;
 width: 100%;
 padding: 40px;
 }

 h1 {
 color: var(--text-primary);
 margin-bottom: 10px;
 font-size: 28px;
 }

 .subtitle {
 color: var(--text-secondary);
 margin-bottom: 30px;
 font-size: 14px;
 }

 .upload-area {
 border: 2px dashed #667eea;padding: 40px;
 text-align: center;
 transition: all 0.3s;
 cursor: pointer;
 margin-bottom: 20px;
 }

 .upload-area:hover {
 border-color: var(--accent-dark);
 background: #f8f9ff;
 }

 .upload-area.dragover {
 background: #f0f2ff;
 border-color: var(--accent-dark);
 }

 .upload-icon {
 font-size: 48px;
 margin-bottom: 16px;
 }

 .upload-text {
 color: var(--text-secondary);
 margin-bottom: 8px;
 }

 .file-info {
 color: var(--accent-dark);
 font-weight: 500;
 margin-top: 12px;
 display: none;
 }

 input[type="file"] {
 display: none;
 }

 .btn {
 width: 100%;
 padding: 14px;
 background: var(--accent-dark);
 color: var(--card-bg);
 border: none;font-size: 16px;
 font-weight: 600;
 cursor: pointer;
 transition: transform 0.2s, box-shadow 0.2s;
 }

 .btn:hover {box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 }

 .btn:disabled {
 background: #ccc;
 cursor: not-allowed;
 transform: none;
 }

 .progress {
 display: none;
 margin-top: 20px;
 }

 .progress-bar {
 width: 100%;
 height: 8px;
 background: #e0e0e0;overflow: hidden;
 }

 .progress-fill {
 height: 100%;
 background: var(--accent-dark);
 width: 0%;
 transition: width 0.3s;
 }

 .progress-text {
 text-align: center;
 margin-top: 8px;
 color: var(--text-secondary);
 font-size: 14px;
 }

 .result {
 margin-top: 20px;
 padding: 20px;
 display: none;
 }

 .result.success {
 background: #d4edda;
 border: 1px solid #c3e6cb;
 color: #155724;
 }

 .result.error {
 background: #f8d7da;
 border: 1px solid #f5c6cb;
 color: #721c24;
 }

 .result-title {
 font-weight: 700;
 margin-bottom: 16px;
 font-size: 18px;
 }

 .result-stats {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
 gap: 12px;
 margin-bottom: 16px;
 }

 .stat-card {
 background: rgba(255, 255, 255, 0.5);
 padding: 12px;
 text-align: center;
 }

 .stat-value {
 font-size: 24px;
 font-weight: 700;
 display: block;
 margin-bottom: 4px;
 }

 .stat-label {
 font-size: 12px;
 opacity: 0.8;
 }

 .result-details {
 font-size: 14px;
 line-height: 1.8;
 margin-top: 16px;
 }

 .warning-section {
 background: #f5f5f5;
 padding: 16px;
 margin-top: 16px;
 border: 1px solid #999;
 border-left: 4px solid #666;
 }

 .warning-title {
 font-weight: 700;
 margin-bottom: 10px;
 color: #333;
 font-size: 14px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .warning-list {
 font-size: 13px;
 color: #555;
 line-height: 1.6;
 }

 .error-section {
 background: #f8f8f8;
 padding: 18px;
 margin-top: 20px;
 border: 2px solid #333;
 border-left: 6px solid #000;
 }

 .error-title {
 font-weight: 700;
 margin-bottom: 14px;
 color: #000;
 font-size: 15px;
 text-transform: uppercase;
 letter-spacing: 1px;
 }

 .error-list {
 font-size: 13px;
 color: #222;
 max-height: 400px;
 overflow-y: auto;
 font-family: 'Courier New', monospace;
 }

 .error-item {
 padding: 10px;
 margin-bottom: 8px;
 background: #fff;
 border: 1px solid #ddd;
 line-height: 1.6;
 }

 .error-item:last-child {
 margin-bottom: 0;
 }

 .error-more {
 margin-top: 14px;
 font-weight: 700;
 color: #000;
 font-size: 13px;
 text-transform: uppercase;
 }

 .action-buttons {
 display: flex;
 gap: 12px;
 margin-top: 20px;
 }

 .btn-view {
 flex: 1;
 padding: 12px;
 background: var(--accent-dark);
 color: var(--card-bg);
 border: none;
 font-size: 14px;
 font-weight: 600;
 cursor: pointer;
 text-align: center;
 text-decoration: none;
 transition: all 0.2s;
 display: inline-block;
 }

 .btn-view:hover {
 background: #5568d3;
 box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 }

 .btn-upload-more {
 flex: 1;
 padding: 12px;
 background: var(--card-bg);
 color: var(--accent-dark);
 border: 2px solid var(--accent-dark);
 font-size: 14px;
 font-weight: 600;
 cursor: pointer;
 transition: all 0.2s;
 }

 .btn-upload-more:hover {
 background: var(--accent-light);
 }

 .organizations-list {
 margin-top: 20px;
 max-height: 400px;
 overflow-y: auto;
 border: 1px solid #c3e6cb;
 background: rgba(255, 255, 255, 0.5);
 }

 .org-item {
 padding: 16px;
 border-bottom: 1px solid #ddd;
 background: #fff;
 }

 .org-item:last-child {
 border-bottom: none;
 }

 .org-item:hover {
 background: #fafafa;
 }

 .org-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 8px;
 }

 .org-info {
 flex: 1;
 }

 .org-name {
 font-weight: 600;
 color: #000;
 margin-bottom: 4px;
 font-size: 14px;
 }

 .org-inn {
 font-size: 12px;
 color: #666;
 font-family: 'Courier New', monospace;
 }

 .org-stats {
 display: flex;
 gap: 12px;
 align-items: center;
 }

 .empty-fields-toggle {
 margin-top: 8px;
 padding: 8px 12px;
 background: #f5f5f5;
 border: 1px solid #ddd;
 cursor: pointer;
 font-size: 13px;
 font-weight: 600;
 color: #333;
 user-select: none;
 }

 .empty-fields-toggle:hover {
 background: #e8e8e8;
 }

 .toggle-icon {
 display: inline-block;
 width: 16px;
 font-size: 12px;
 margin-right: 8px;
 }

 .empty-fields-list {
 margin-top: 8px;
 padding: 12px;
 background: #fafafa;
 border: 1px solid #ddd;
 border-top: none;
 }

 .empty-field-item {
 padding: 6px 8px;
 margin-bottom: 4px;
 background: #fff;
 border-left: 3px solid #999;
 font-size: 12px;
 color: #555;
 font-family: 'Courier New', monospace;
 }

 .empty-field-item:last-child {
 margin-bottom: 0;
 }

 .empty-fields-count {
 margin-top: 8px;
 padding: 8px 12px;
 background: #f5f5f5;
 border: 1px solid #ddd;
 font-size: 13px;
 font-weight: 600;
 color: #333;
 }

 .org-badge {
 padding: 4px 10px;
 border-radius: 2px;
 font-size: 10px;
 font-weight: 700;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .badge-new {
 background: #000;
 color: #fff;
 border: 1px solid #000;
 }

 .badge-updated {
 background: #666;
 color: #fff;
 border: 1px solid #666;
 }

 .empty-fields {
 font-size: 12px;
 color: #333;
 font-weight: 500;
 }

 .empty-fields.critical {
 color: #000;
 font-weight: 700;
 text-decoration: underline;
 }

 .list-header {
 padding: 14px 16px;
 background: #e8e8e8;
 font-weight: 700;
 color: #000;
 position: sticky;
 top: 0;
 z-index: 1;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 font-size: 12px;
 border-bottom: 2px solid #333;
 }

 .back-link {
 display: inline-block;
 margin-top: 20px;
 color: var(--accent-dark);
 text-decoration: none;
 font-weight: 500;
 }

 .back-link:hover {
 text-decoration: underline;
 }
</style>
</head>
<body>
 <div class="container">
 <h1>Загрузка данных предприятий</h1>
 <p class="subtitle">Загрузите Excel файл с данными о предприятиях (208 столбцов)</p>

 <form id="uploadForm">
 <div class="upload-area" id="uploadArea">
 <div class="upload-icon"></div>
 <div class="upload-text">Нажмите или перетащите файл Excel</div>
 <div class="file-info" id="fileInfo"></div>
 <input type="file" id="fileInput" accept=".xlsx,.xls" required>
</div>

 <button type="submit" class="btn" id="submitBtn">Загрузить и обработать</button>
</form>

 <div class="progress" id="progress">
 <div class="progress-bar">
 <div class="progress-fill" id="progressFill"></div>
</div>
 <div class="progress-text" id="progressText">Обработка файла...</div>
</div>

 <div class="result" id="result"></div>

 <a href="/" class="back-link">← Вернуться на главную</a>
</div>

 <script>
 const uploadArea = document.getElementById('uploadArea');
 const fileInput = document.getElementById('fileInput');
 const fileInfo = document.getElementById('fileInfo');
 const form = document.getElementById('uploadForm');
 const submitBtn = document.getElementById('submitBtn');
 const progress = document.getElementById('progress');
 const progressFill = document.getElementById('progressFill');
 const progressText = document.getElementById('progressText');
 const result = document.getElementById('result');

 // Click to upload
 uploadArea.addEventListener('click', () => fileInput.click());

 // Drag and drop
 uploadArea.addEventListener('dragover', (e) => {
 e.preventDefault();
 uploadArea.classList.add('dragover');
 });

 uploadArea.addEventListener('dragleave', () => {
 uploadArea.classList.remove('dragover');
 });

 uploadArea.addEventListener('drop', (e) => {
 e.preventDefault();
 uploadArea.classList.remove('dragover');
 const files = e.dataTransfer.files;
 if (files.length > 0) {
 fileInput.files = files;
 showFileInfo(files[0]);
 }
 });

 // File selected
 fileInput.addEventListener('change', (e) => {
 if (e.target.files.length > 0) {
 showFileInfo(e.target.files[0]);
 }
 });

 function showFileInfo(file) {
 fileInfo.textContent = `Выбран: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
 fileInfo.style.display = 'block';
 }

 // Form submit
 form.addEventListener('submit', async (e) => {
 e.preventDefault();

 const file = fileInput.files[0];
 if (!file) {
 alert('Пожалуйста, выберите файл');
 return;
 }

 const formData = new FormData();
 formData.append('file', file);

 // Show progress
 submitBtn.disabled = true;
 progress.style.display = 'block';
 result.style.display = 'none';
 progressFill.style.width = '0%';

 try {
 // Simulate progress
 let progressValue = 0;
 const progressInterval = setInterval(() => {
 progressValue += Math.random() * 15;
 if (progressValue > 90) progressValue = 90;
 progressFill.style.width = progressValue + '%';
 }, 200);

 const response = await fetch('/upload', {
 method: 'POST',
 body: formData
 });

 clearInterval(progressInterval);
 progressFill.style.width = '100%';

 const data = await response.json();

 if (response.ok) {
 showSuccessResult(data);
 } else {
 showResult('error', 'Ошибка при обработке файла', data.detail || 'Неизвестная ошибка');
 }
 } catch (error) {
 showResult('error', 'Ошибка соединения', error.message);
 } finally {
 submitBtn.disabled = false;
 setTimeout(() => {
 progress.style.display = 'none';
 }, 1000);
 }
 });

 function showSuccessResult(data) {
 const missingWarnings = [];
 if (data.missing_fields) {
 if (data.missing_fields.contacts > 0) 
 missingWarnings.push(`У ${data.missing_fields.contacts} предприятий нет контактных данных`);
 if (data.missing_fields.coordinates > 0) 
 missingWarnings.push(`У ${data.missing_fields.coordinates} предприятий нет координат`);
 if (data.missing_fields.metrics > 0) 
 missingWarnings.push(`У ${data.missing_fields.metrics} предприятий нет финансовых показателей`);
 if (data.missing_fields.taxes > 0) 
 missingWarnings.push(`У ${data.missing_fields.taxes} предприятий нет данных по налогам`);
 if (data.missing_fields.assets > 0) 
 missingWarnings.push(`У ${data.missing_fields.assets} предприятий нет данных об имуществе`);
 if (data.missing_fields.products > 0) 
 missingWarnings.push(`У ${data.missing_fields.products} предприятий нет информации о продукции`);
 }

 let warningHtml = '';
 if (missingWarnings.length > 0) {
 warningHtml = `
 <div class="warning-section">
 <div class="warning-title">ПРЕДУПРЕЖДЕНИЕ: Обнаружены неполные данные</div>
 <div class="warning-list">
 ${missingWarnings.map(w => `${w}`).join('<br>')}
 </div>
 </div>
 `;
 }

 // Build organizations list with toggle for empty fields
 let organizationsListHtml = '';
 if (data.organizations_details && data.organizations_details.length > 0) {
 const orgItems = data.organizations_details.map((org, index) => {
 const badge = org.is_new ? 
 '<span class="org-badge badge-new">НОВОЕ</span>' : 
 '<span class="org-badge badge-updated">ОБНОВЛЕНО</span>';
 
 // Build empty fields list if available
 let emptyFieldsHtml = '';
 if (org.empty_fields_list && org.empty_fields_list.length > 0) {
 emptyFieldsHtml = `
 <div class="empty-fields-toggle" onclick="toggleEmptyFields(${index})">
 <span class="toggle-icon" id="toggle-icon-${index}">▶</span>
 Пустых полей: ${org.empty_fields}
 </div>
 <div class="empty-fields-list" id="empty-fields-${index}" style="display: none;">
 ${org.empty_fields_list.map(field => `<div class="empty-field-item">${field}</div>`).join('')}
 </div>
 `;
 } else if (org.empty_fields > 0) {
 emptyFieldsHtml = `<div class="empty-fields-count">Пустых полей: ${org.empty_fields}</div>`;
 }
 
 return `
 <div class="org-item">
 <div class="org-header">
 <div class="org-info">
 <div class="org-name">${org.name}</div>
 <div class="org-inn">ИНН: ${org.inn}</div>
 </div>
 <div class="org-stats">
 ${badge}
 </div>
 </div>
 ${emptyFieldsHtml}
 </div>
 `;
 }).join('');

 const showingCount = data.organizations_details.length;
 const totalCount = data.organizations_count;
 
 organizationsListHtml = `
 <div class="organizations-list">
 <div class="list-header">
 Загруженные предприятия (показаны первые ${showingCount} из ${totalCount})
 </div>
 ${orgItems}
 </div>
 `;
 }

 result.className = 'result success';
 result.innerHTML = `
 <div class="result-title">ФАЙЛ УСПЕШНО ОБРАБОТАН</div>
 <div class="result-stats">
 <div class="stat-card">
 <span class="stat-value">${data.organizations_count}</span>
 <span class="stat-label">Всего предприятий</span>
 </div>
 <div class="stat-card">
 <span class="stat-value">${data.organizations_new || 0}</span>
 <span class="stat-label">Новых</span>
 </div>
 <div class="stat-card">
 <span class="stat-value">${data.organizations_updated || 0}</span>
 <span class="stat-label">Обновлено</span>
 </div>
 </div>
 ${warningHtml}
 ${organizationsListHtml}
 ${data.rows_skipped > 0 ? `<div class="result-details">Пропущено пустых строк: ${data.rows_skipped}</div>` : ''}
 ${data.errors > 0 && data.error_details ? `
 <div class="error-section">
 <div class="error-title">ОШИБКИ ПРИ ОБРАБОТКЕ (${data.errors})</div>
 <div class="error-list">
 ${data.error_details.map(err => `<div class="error-item">${err}</div>`).join('')}
 ${data.errors > data.error_details.length ? `<div class="error-more">Всего ошибок: ${data.errors}. Показаны первые ${data.error_details.length}.</div>` : ''}
 </div>
 </div>
 ` : ''}
 <div class="action-buttons">
 <a href="/organizations" class="btn-view">Перейти к списку предприятий</a>
 <button onclick="resetForm()" class="btn-upload-more">Загрузить ещё файл</button>
 </div>
 `;
 result.style.display = 'block';
 }

 function toggleEmptyFields(index) {
 const list = document.getElementById(`empty-fields-${index}`);
 const icon = document.getElementById(`toggle-icon-${index}`);
 
 if (list.style.display === 'none') {
 list.style.display = 'block';
 icon.textContent = '▼';
 } else {
 list.style.display = 'none';
 icon.textContent = '▶';
 }
 }

 function resetForm() {
 form.reset();
 fileInfo.style.display = 'none';
 result.style.display = 'none';
 progress.style.display = 'none';
 }

 function showResult(type, title, details) {
 result.className = `result ${type}`;
 result.innerHTML = `
 <div class="result-title">${title}</div>
 <div class="result-details">${details}</div>
 `;
 result.style.display = 'block';
 }
</script>
</body>
</html>
