<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Полное редактирование: {{ org.name }}</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <style>
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 background: #f5f5f5;
 min-height: 100vh;
 padding: 0;
 margin: 0;
 }

 .container {
 max-width: 100%;
 margin: 0 auto;
 background: #ffffff;
 overflow: hidden;
 min-height: 100vh;
 }

 /* Page Header */
 .page-header {
 background: #ffffff;
 border-bottom: 1px solid #e0e0e0;
 padding: 20px 60px;
 margin-bottom: 0;
 display: flex;
 justify-content: space-between;
 align-items: center;
 max-width: 100%;
 }

 .header-left {
 display: flex;
 align-items: center;
 gap: 24px;
 }

 .header-logo {
 height: 60px;
 width: auto;
 }

 .page-title-section {
 background: #f8f9fa;
 padding: 30px 60px;
 border-bottom: 1px solid #e0e0e0;
 max-width: 1400px;
 margin: 0 auto;
 }

 .page-title {
 font-size: 28px;
 font-weight: 700;
 color: #1a1a1a;
 margin-bottom: 8px;
 }

 .page-subtitle {
 font-size: 14px;
 color: #666;
 display: flex;
 gap: 16px;
 align-items: center;
 margin-top: 8px;
 margin-bottom: 20px;
 }

 .header-actions {
 display: flex;
 gap: 12px;
 margin-top: 16px;
 flex-wrap: wrap;
 }

 .header-actions a,
 .btn-secondary {
 padding: 12px 24px;
 background: transparent;
 color: #333;
 border: 2px solid #e0e0e0;
 font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 text-transform: uppercase;
 letter-spacing: 0.3px;
 }

 .header-actions a:hover,
 .btn-secondary:hover {
 border-color: #2c3e50;
 color: #2c3e50;
 }

 .btn-primary,
 .btn-dark {
 padding: 12px 24px;
 background: #2c3e50;
 color: #ffffff;
 border: none;
 font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 text-transform: uppercase;
 letter-spacing: 0.3px;
 }

 .btn-primary:hover,
 .btn-dark:hover {
 background: #34495e;
 transform: translateY(-1px);
 box-shadow: 0 4px 8px rgba(0,0,0,0.2);
 }

 .btn {
 padding: 10px 20px;
 border: none;
 cursor: pointer;
 font-size: 14px;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 5px;
 transition: all 0.3s;
 text-transform: uppercase;
 letter-spacing: 0.3px;
 }

 .btn-success {
 background: #28a745;
 color: #ffffff;
 }

 .btn-success:hover {
 background: #218838;
 }

 .btn-danger {
 background: #dc3545;
 color: #ffffff;
 }

 .btn-small {
 padding: 5px 10px;
 font-size: 12px;
 }

 .tabs {
 display: flex;
 background: #f8f9fa;
 border-bottom: 2px solid #e0e0e0;
 overflow-x: auto;
 padding: 0;
 max-width: 1400px;
 margin: 0 auto;
 }

 .tab {
 padding: 16px 28px;
 background: transparent;
 border: none;
 cursor: pointer;
 font-size: 14px;
 font-weight: 600;
 color: #666;
 white-space: nowrap;
 transition: all 0.3s ease;
 border-bottom: 3px solid transparent;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .tab:hover {
 color: #333;
 background: rgba(0, 0, 0, 0.03);
 }

 .tab.active {
 color: #2c3e50;
 border-bottom-color: #2c3e50;
 background: #ffffff;
 }

 .tab-content {
 display: none;
 }

 .tab-content.active {
 display: block;
 }

 .card {
 background: #ffffff;
 padding: 40px 60px;
 max-width: 1400px;
 margin: 0 auto 20px auto;
 }

 .card h2 {
 color: #1a1a1a;
 font-size: 18px;
 font-weight: 700;
 margin-bottom: 20px;
 padding-bottom: 12px;
 border-bottom: 2px solid #e0e0e0;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .section-divider {
 margin: 30px 0 20px 0;
 padding: 12px 15px;
 background: #f8f9fa;
 border-left: 4px solid #2c3e50;
 }

 .section-divider h3 {
 color: #1a1a1a;
 font-size: 16px;
 font-weight: 600;
 margin: 0;
 display: flex;
 align-items: center;
 gap: 8px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .form-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
 gap: 20px;
 margin-bottom: 20px;
 }

 .form-group {
 display: flex;
 flex-direction: column;
 }

 .form-group.full-width {
 grid-column: 1 / -1;
 }

 .form-group label {
 color: #666;
 font-size: 12px;
 font-weight: 600;
 margin-bottom: 8px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .form-group input[type="text"],
 .form-group input[type="email"],
 .form-group input[type="number"],
 .form-group input[type="date"],
 .form-group textarea,
 .form-group select {
 padding: 10px;
 border: 1px solid #e0e0e0;
 font-size: 14px;
 transition: border-color 0.3s;
 background: #f8f9fa;
 color: #1a1a1a;
 }

 .form-group input:focus,
 .form-group textarea:focus,
 .form-group select:focus {
 outline: none;
 border-color: #2c3e50;
 background: #ffffff;
 }

 .form-group textarea {
 resize: vertical;
 min-height: 80px;
 }

 .checkbox-group {
 display: flex;
 align-items: center;
 gap: 10px;
 }

 .checkbox-group input[type="checkbox"] {
 width: 20px;
 height: 20px;
 cursor: pointer;
 }

 .table-responsive {
 overflow-x: auto;
 margin-bottom: 20px;
 }

 table {
 width: 100%;
 border-collapse: collapse;
 background: #ffffff;
 }

 th {
 background: #f8f9fa;
 padding: 14px 16px;
 text-align: left;
 font-weight: 600;
 color: #333;
 border-bottom: 2px solid #e0e0e0;
 font-size: 12px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 td {
 padding: 12px;
 border-bottom: 1px solid #f0f0f0;
 }

 td input {
 width: 100%;
 padding: 8px;
 border: 1px solid #e0e0e0;
 font-size: 13px;
 background: #f8f9fa;
 color: #1a1a1a;
 }

 td input:focus {
 outline: none;
 border-color: #2c3e50;
 background: #ffffff;
 }

 tbody tr:hover {
 background: #f8f9fa;
 }

 .alert {
 padding: 15px 20px;
 margin: 20px auto;
 max-width: 1400px;
 display: none;
 font-weight: 500;
 }

 .alert-success {
 background: #d4edda;
 color: #155724;
 border: 1px solid #c3e6cb;
 border-left: 4px solid #28a745;
 }

 .alert-error {
 background: #f8d7da;
 color: #721c24;
 border: 1px solid #f5c6cb;
 border-left: 4px solid #dc3545;
 }

 .item-row {
 background: #f8f9fa;
 padding: 20px;
 margin-bottom: 20px;
 position: relative;
 border-left: 4px solid #2c3e50;
 }

 .item-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 15px;
 }

 .item-title {
 font-weight: 600;
 color: #1a1a1a;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 font-size: 14px;
 }

 .remove-btn {
 background: #dc3545;
 color: #ffffff;
 border: none;
 padding: 8px 16px;
 cursor: pointer;
 font-size: 12px;
 text-transform: uppercase;
 letter-spacing: 0.3px;
 transition: all 0.3s ease;
 }

 .remove-btn:hover {
 background: #c82333;
 transform: translateY(-1px);
 box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
 }

 .add-item-btn {
 margin-top: 10px;
 }

 @media (max-width: 768px) {
 .form-grid {
 grid-template-columns: 1fr;
 }

 .tabs {
 flex-direction: column;
 }
 }
</style>
</head>
<body>
 <div class="container">
 <div class="page-header">
 <div class="header-left">
 <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 80'%3E%3Cg fill='%23000000'%3E%3Cpath d='M20,50 L35,30 L35,60 Z'/%3E%3Cpath d='M40,50 L55,30 L55,60 Z'/%3E%3Cpath d='M60,50 L75,30 L75,60 Z'/%3E%3Crect x='15' y='60' width='65' height='15'/%3E%3Ccircle cx='52' cy='25' r='8'/%3E%3Cline x1='52' y1='17' x2='52' y2='10' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='52' y1='10' x2='45' y2='15' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='52' y1='10' x2='59' y2='15' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='44' y1='25' x2='35' y2='25' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='35' y1='25' x2='40' y2='20' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='35' y1='25' x2='40' y2='30' stroke='%23000000' stroke-width='2'/%3E%3C/g%3E%3Ctext x='95' y='30' font-family='Arial, sans-serif' font-size='16' font-weight='bold' fill='%23000000'%3EИНДУСТРИАЛЬНЫЕ%3C/text%3E%3Ctext x='95' y='50' font-family='Arial, sans-serif' font-size='16' font-weight='bold' fill='%23000000'%3EДАННЫЕ%3C/text%3E%3Ctext x='95' y='70' font-family='Arial, sans-serif' font-size='16' font-weight='bold' fill='%23000000'%3EМОСКВЫ%3C/text%3E%3C/svg%3E" alt="Индустриальные данные Москвы" class="header-logo">
 </div>
 <div class="header-actions">
 <a href="/organizations" class="btn-secondary">К СПИСКУ</a>
 <a href="/analytics" class="btn-secondary">АНАЛИТИКА</a>
 <a href="/upload" class="btn-secondary">ЗАГРУЗКА</a>
 </div>
 </div>

 <div class="page-title-section">
 <h1 class="page-title">ПОЛНОЕ РЕДАКТИРОВАНИЕ: {{ org.name }}</h1>
 <div class="page-subtitle">
 <span>ИНН: {{ org.inn }}</span>
 </div>
 <div class="header-actions">
 <a href="/organizations/{{ org.id }}" class="btn-secondary">ОТМЕНА</a>
 <button type="button" onclick="saveAllChanges()" class="btn-dark">СОХРАНИТЬ ВСЕ ИЗМЕНЕНИЯ</button>
 </div>
 </div>

 <div class="alert alert-success" id="successAlert">Изменения успешно сохранены!</div>
 <div class="alert alert-error" id="errorAlert">Ошибка при сохранении</div>

 <div class="tabs">
 <div class="tab active" onclick="switchTab('general')">Общая информация</div>
 <div class="tab" onclick="switchTab('metrics')">Финансовые показатели</div>
 <div class="tab" onclick="switchTab('taxes')">Налоги</div>
 <div class="tab" onclick="switchTab('assets')"> Имущество</div>
 <div class="tab" onclick="switchTab('products')"> Продукция</div>
 <div class="tab" onclick="switchTab('meta')"> Дополнительно</div>
</div>

 <!-- Общая информация -->
 <div id="general" class="tab-content active">
 <div class="card">
 <h2>Общая информация организации</h2>
 <form id="generalForm">
 
 <!-- Основные реквизиты -->
 <div class="section-divider">
 <h3> Основные реквизиты</h3>
</div>
 <div class="form-grid">
 <div class="form-group full-width">
 <label>Наименование *</label>
 <input type="text" name="name" value="{{ org.name or '' }}" required>
</div>
 <div class="form-group full-width">
 <label>Полное наименование</label>
 <input type="text" name="full_name" value="{{ org.full_name or '' }}">
</div>
 <div class="form-group">
 <label>ИНН *</label>
 <input type="text" name="inn" value="{{ org.inn or '' }}" required>
</div>
 <div class="form-group">
 <label>Дата регистрации</label>
 <input type="date" name="registration_date" value="{{ org.registration_date or '' }}">
</div>
</div>

 <!-- Статусы -->
 <div class="section-divider">
 <h3>Статусы и классификация</h3>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Статус Spark</label>
 <input type="text" name="status_spark" value="{{ org.status_spark or '' }}">
</div>
 <div class="form-group">
 <label>Внутренний статус</label>
 <input type="text" name="status_internal" value="{{ org.status_internal or '' }}">
</div>
 <div class="form-group">
 <label>Финальный статус</label>
 <input type="text" name="status_final" value="{{ org.status_final or '' }}">
</div>
 <div class="form-group">
 <label>Статус МСП</label>
 <input type="text" name="msp_status" value="{{ org.msp_status or '' }}">
</div>
 <div class="form-group">
 <label>Специальный статус</label>
 <input type="text" name="special_status" value="{{ org.special_status or '' }}">
</div>
 <div class="form-group">
 <label>Финальный сайт</label>
 <input type="text" name="site_final" value="{{ org.site_final or '' }}">
</div>
 <div class="form-group">
 <div class="checkbox-group">
 <input type="checkbox" name="got_moscow_support" {% if org.got_moscow_support %}checked{% endif %}>
 <label>Получала поддержку Москвы</label>
</div>
</div>
 <div class="form-group">
 <div class="checkbox-group">
 <input type="checkbox" name="is_system_critical" {% if org.is_system_critical %}checked{% endif %}>
 <label>Системообразующая</label>
</div>
</div>
</div>

 <!-- Адреса и местоположение -->
 <div class="section-divider">
 <h3> Адреса и местоположение</h3>
</div>
 <div class="form-grid">
 <div class="form-group full-width">
 <label>Юридический адрес</label>
 <textarea name="legal_address">{{ org.legal_address or '' }}</textarea>
</div>
 <div class="form-group">
 <label>Координаты юр. адреса</label>
 <input type="text" name="legal_address_coords" value="{{ org.legal_address_coords or '' }}" placeholder="55.751244, 37.618423">
</div>
 <div class="form-group full-width">
 <label>Адрес производства</label>
 <textarea name="production_address">{{ org.production_address or '' }}</textarea>
</div>
 <div class="form-group">
 <label>Координаты производства</label>
 <input type="text" name="production_address_coords" value="{{ org.production_address_coords or '' }}" placeholder="55.751244, 37.618423">
</div>
 <div class="form-group full-width">
 <label>Дополнительная площадка</label>
 <textarea name="additional_address">{{ org.additional_address or '' }}</textarea>
</div>
 <div class="form-group">
 <label>Координаты доп. площадки</label>
 <input type="text" name="additional_address_coords" value="{{ org.additional_address_coords or '' }}" placeholder="55.751244, 37.618423">
</div>
 <div class="form-group">
 <label>Широта (основная)</label>
 <input type="number" step="0.000001" name="coordinates_lat" value="{{ org.coordinates_lat or '' }}" placeholder="55.751244">
</div>
 <div class="form-group">
 <label>Долгота (основная)</label>
 <input type="number" step="0.000001" name="coordinates_lon" value="{{ org.coordinates_lon or '' }}" placeholder="37.618423">
</div>
 <div class="form-group">
 <label>Округ Москвы</label>
 <input type="text" name="district" value="{{ org.district or '' }}" placeholder="ЦАО">
</div>
 <div class="form-group">
 <label>Район Москвы</label>
 <input type="text" name="region" value="{{ org.region or '' }}" placeholder="Хамовники">
</div>
</div>

 <!-- Отрасли и ОКВЭД -->
 <div class="section-divider">
 <h3>Отрасли и коды ОКВЭД</h3>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Основная отрасль</label>
 <input type="text" name="main_industry" value="{{ org.main_industry or '' }}">
</div>
 <div class="form-group">
 <label>Основная подотрасль</label>
 <input type="text" name="main_subindustry" value="{{ org.main_subindustry or '' }}">
</div>
 <div class="form-group">
 <label>Дополнительная отрасль</label>
 <input type="text" name="extra_industry" value="{{ org.extra_industry or '' }}">
</div>
 <div class="form-group">
 <label>Дополнительная подотрасль</label>
 <input type="text" name="extra_subindustry" value="{{ org.extra_subindustry or '' }}">
</div>
 <div class="form-group">
 <label>Основной ОКВЭД</label>
 <input type="text" name="main_okved" value="{{ org.main_okved or '' }}" placeholder="25.11">
</div>
 <div class="form-group">
 <label>Название основного ОКВЭД</label>
 <input type="text" name="main_okved_name" value="{{ org.main_okved_name or '' }}">
</div>
 <div class="form-group">
 <label>ОКВЭД производства</label>
 <input type="text" name="prod_okved" value="{{ org.prod_okved or '' }}" placeholder="25.11">
</div>
 <div class="form-group">
 <label>Название ОКВЭД производства</label>
 <input type="text" name="prod_okved_name" value="{{ org.prod_okved_name or '' }}">
</div>
</div>

 <!-- Размер компании -->
 <div class="section-divider">
 <h3>Размер компании</h3>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Размер компании (текущий)</label>
 <input type="text" name="company_size" value="{{ org.company_size or '' }}" placeholder="Средняя">
</div>
 <div class="form-group">
 <label>Размер компании (2022)</label>
 <input type="text" name="company_size_2022" value="{{ org.company_size_2022 or '' }}" placeholder="Средняя">
</div>
 <div class="form-group">
 <label>Размер по сотрудникам (текущий)</label>
 <input type="text" name="size_by_employees" value="{{ org.size_by_employees or '' }}" placeholder="100-250 чел.">
</div>
 <div class="form-group">
 <label>Размер по сотрудникам (2022)</label>
 <input type="text" name="size_by_employees_2022" value="{{ org.size_by_employees_2022 or '' }}" placeholder="100-250 чел.">
</div>
 <div class="form-group">
 <label>Размер по выручке (текущий)</label>
 <input type="text" name="size_by_revenue" value="{{ org.size_by_revenue or '' }}" placeholder="500 млн - 2 млрд">
</div>
 <div class="form-group">
 <label>Размер по выручке (2022)</label>
 <input type="text" name="size_by_revenue_2022" value="{{ org.size_by_revenue_2022 or '' }}" placeholder="500 млн - 2 млрд">
</div>
</div>

 <!-- Руководство и структура -->
 <div class="section-divider">
 <h3> Руководство и организационная структура</h3>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>ФИО руководителя</label>
 <input type="text" name="head_name" value="{{ org.head_name or '' }}">
</div>
 <div class="form-group">
 <label>Контакты руководителя</label>
 <input type="text" name="head_contacts" value="{{ org.head_contacts or '' }}">
</div>
 <div class="form-group">
 <label>Email руководителя</label>
 <input type="email" name="head_email" value="{{ org.head_email or '' }}">
</div>
 <div class="form-group">
 <label>Родительская организация</label>
 <input type="text" name="parent_org_name" value="{{ org.parent_org_name or '' }}">
</div>
 <div class="form-group">
 <label>ИНН родительской организации</label>
 <input type="text" name="parent_org_inn" value="{{ org.parent_org_inn or '' }}">
</div>
 <div class="form-group">
 <label>Тип связи с родительской орг.</label>
 <input type="text" name="parent_relation_type" value="{{ org.parent_relation_type or '' }}" placeholder="Дочернее предприятие">
</div>
</div>

 <!-- Контактная информация -->
 <div class="section-divider">
 <h3> Контактная информация</h3>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Контакт сотрудника</label>
 <input type="text" name="employee_contact" value="{{ org.employee_contact or '' }}">
</div>
 <div class="form-group">
 <label>Телефон</label>
 <input type="text" name="phone" value="{{ org.phone or '' }}" placeholder="+7 (495) 123-45-67">
</div>
 <div class="form-group">
 <label>Экстренный контакт</label>
 <input type="text" name="emergency_contact" value="{{ org.emergency_contact or '' }}">
</div>
 <div class="form-group">
 <label>Веб-сайт</label>
 <input type="text" name="website" value="{{ org.website or '' }}" placeholder="https://example.com">
</div>
 <div class="form-group">
 <label>Email организации</label>
 <input type="email" name="email" value="{{ org.email or '' }}" placeholder="info@example.com">
</div>
</div>

 <!-- Дополнительная информация -->
 <div class="section-divider">
 <h3> Дополнительная информация</h3>
</div>
 <div class="form-grid">
 <div class="form-group full-width">
 <label>Информация о компании</label>
 <textarea name="company_info" rows="4">{{ org.company_info or '' }}</textarea>
</div>
 <div class="form-group full-width">
 <label>Данные о поддержке</label>
 <textarea name="support_data" rows="3">{{ org.support_data or '' }}</textarea>
</div>
 <div class="form-group">
 <label>Дата добавления в систему</label>
 <input type="date" name="date_added" value="{{ org.date_added or '' }}">
</div>
</div>

</form>
</div>
</div>

 <!-- Финансовые показатели -->
 <div id="metrics" class="tab-content">
 <div class="card">
 <h2>Финансовые показатели по годам</h2>
 <div class="table-responsive">
 <table id="metricsTable">
 <thead>
 <tr>
 <th>Год</th>
 <th>Выручка (тыс. руб)</th>
 <th>Прибыль (тыс. руб)</th>
 <th>Всего сотр.</th>
 <th>Сотр. в Москве</th>
 <th>ФОТ всего</th>
 <th>ФОТ Москвы</th>
 <th>Ср. ЗП всего</th>
 <th>Ср. ЗП Москва</th>
 <th>Инвестиции</th>
 <th>Экспорт</th>
 <th>Действия</th>
</tr>
</thead>
 <tbody id="metricsBody">
 {% for metric in metrics %}
 <tr data-id="{{ metric.id }}">
 <td><input type="number" name="year" value="{{ metric.year }}" required></td>
 <td><input type="number" step="0.01" name="revenue" value="{{ metric.revenue or '' }}"></td>
 <td><input type="number" step="0.01" name="profit" value="{{ metric.profit or '' }}"></td>
 <td><input type="number" name="total_employees" value="{{ metric.total_employees or '' }}"></td>
 <td><input type="number" name="moscow_employees" value="{{ metric.moscow_employees or '' }}"></td>
 <td><input type="number" step="0.01" name="total_fot" value="{{ metric.total_fot or '' }}"></td>
 <td><input type="number" step="0.01" name="moscow_fot" value="{{ metric.moscow_fot or '' }}"></td>
 <td><input type="number" step="0.01" name="avg_salary_total" value="{{ metric.avg_salary_total or '' }}"></td>
 <td><input type="number" step="0.01" name="avg_salary_moscow" value="{{ metric.avg_salary_moscow or '' }}"></td>
 <td><input type="number" step="0.01" name="investments" value="{{ metric.investments or '' }}"></td>
 <td><input type="number" step="0.01" name="export_volume" value="{{ metric.export_volume or '' }}"></td>
 <td><button type="button" class="remove-btn" onclick="removeRow(this)"></button></td>
</tr>
 {% endfor %}
</tbody>
</table>
</div>
 <button type="button" class="btn btn-success add-item-btn" onclick="addMetricRow()">+ Добавить год</button>
</div>
</div>

 <!-- Налоги -->
 <div id="taxes" class="tab-content">
 <div class="card">
 <h2>Налоги по годам</h2>
 <div class="table-responsive">
 <table id="taxesTable">
 <thead>
 <tr>
 <th>Год</th>
 <th>Всего налогов</th>
 <th>Налог на прибыль</th>
 <th>Налог на имущество</th>
 <th>Земельный налог</th>
 <th>НДФЛ</th>
 <th>Транспортный</th>
 <th>Прочие</th>
 <th>Акциз</th>
 <th>Действия</th>
</tr>
</thead>
 <tbody id="taxesBody">
 {% for tax in taxes %}
 <tr data-id="{{ tax.id }}">
 <td><input type="number" name="year" value="{{ tax.year }}" required></td>
 <td><input type="number" step="0.01" name="total_taxes_moscow" value="{{ tax.total_taxes_moscow or '' }}"></td>
 <td><input type="number" step="0.01" name="profit_tax" value="{{ tax.profit_tax or '' }}"></td>
 <td><input type="number" step="0.01" name="property_tax" value="{{ tax.property_tax or '' }}"></td>
 <td><input type="number" step="0.01" name="land_tax" value="{{ tax.land_tax or '' }}"></td>
 <td><input type="number" step="0.01" name="ndfl" value="{{ tax.ndfl or '' }}"></td>
 <td><input type="number" step="0.01" name="transport_tax" value="{{ tax.transport_tax or '' }}"></td>
 <td><input type="number" step="0.01" name="other_taxes" value="{{ tax.other_taxes or '' }}"></td>
 <td><input type="number" step="0.01" name="excise" value="{{ tax.excise or '' }}"></td>
 <td><button type="button" class="remove-btn" onclick="removeRow(this)"></button></td>
</tr>
 {% endfor %}
</tbody>
</table>
</div>
 <button type="button" class="btn btn-success add-item-btn" onclick="addTaxRow()">+ Добавить год</button>
</div>
</div>

 <!-- Имущество -->
 <div id="assets" class="tab-content">
 <div class="card">
 <h2>Имущество и активы</h2>
 <div id="assetsContainer">
 {% for asset in assets %}
 <div class="item-row" data-id="{{ asset.id }}">
 <div class="item-header">
 <span class="item-title">Актив #{{ loop.index }}</span>
 <button type="button" class="remove-btn" onclick="removeAsset(this)"> Удалить</button>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Кадастровый номер земли</label>
 <input type="text" name="cadastral_number_land" value="{{ asset.cadastral_number_land or '' }}">
</div>
 <div class="form-group">
 <label>Площадь земли (кв.м)</label>
 <input type="number" step="0.01" name="land_area" value="{{ asset.land_area or '' }}">
</div>
 <div class="form-group">
 <label>Использование земли</label>
 <input type="text" name="land_usage" value="{{ asset.land_usage or '' }}">
</div>
 <div class="form-group">
 <label>Тип собственности земли</label>
 <input type="text" name="land_ownership_type" value="{{ asset.land_ownership_type or '' }}">
</div>
 <div class="form-group">
 <label>Собственник земли</label>
 <input type="text" name="land_owner" value="{{ asset.land_owner or '' }}">
</div>
 <div class="form-group">
 <label>Кадастровый номер здания</label>
 <input type="text" name="cadastral_number_building" value="{{ asset.cadastral_number_building or '' }}">
</div>
 <div class="form-group">
 <label>Площадь здания (кв.м)</label>
 <input type="number" step="0.01" name="building_area" value="{{ asset.building_area or '' }}">
</div>
 <div class="form-group">
 <label>Использование здания</label>
 <input type="text" name="building_usage" value="{{ asset.building_usage or '' }}">
</div>
 <div class="form-group">
 <label>Тип здания</label>
 <input type="text" name="building_type" value="{{ asset.building_type or '' }}">
</div>
 <div class="form-group">
 <label>Назначение здания</label>
 <input type="text" name="building_purpose" value="{{ asset.building_purpose or '' }}">
</div>
 <div class="form-group">
 <label>Тип собственности здания</label>
 <input type="text" name="building_ownership_type" value="{{ asset.building_ownership_type or '' }}">
</div>
 <div class="form-group">
 <label>Собственник здания</label>
 <input type="text" name="building_owner" value="{{ asset.building_owner or '' }}">
</div>
 <div class="form-group">
 <label>Производственная площадь (кв.м)</label>
 <input type="number" step="0.01" name="production_area" value="{{ asset.production_area or '' }}">
</div>
 <div class="form-group full-width">
 <label>Сводная информация об имуществе</label>
 <textarea name="property_summary">{{ asset.property_summary or '' }}</textarea>
</div>
</div>
</div>
 {% endfor %}
</div>
 <button type="button" class="btn btn-success add-item-btn" onclick="addAsset()">+ Добавить актив</button>
</div>
</div>

 <!-- Продукция -->
 <div id="products" class="tab-content">
 <div class="card">
 <h2>Продукция и производство</h2>
 <div id="productsContainer">
 {% for product in products %}
 <div class="item-row" data-id="{{ product.id }}">
 <div class="item-header">
 <span class="item-title">Продукт #{{ loop.index }}</span>
 <button type="button" class="remove-btn" onclick="removeProduct(this)"> Удалить</button>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Название продукта</label>
 <input type="text" name="product_name" value="{{ product.product_name or '' }}">
</div>
 <div class="form-group">
 <label>Стандартизированный продукт</label>
 <input type="text" name="standardized_product" value="{{ product.standardized_product or '' }}">
</div>
 <div class="form-group">
 <label>Коды ОКПД2</label>
 <input type="text" name="okpd2_codes" value="{{ product.okpd2_codes or '' }}">
</div>
 <div class="form-group">
 <label>Типы продукции</label>
 <input type="text" name="product_types" value="{{ product.product_types or '' }}">
</div>
 <div class="form-group">
 <label>Каталог продукции</label>
 <input type="text" name="product_catalog" value="{{ product.product_catalog or '' }}">
</div>
 <div class="form-group">
 <label>Загрузка мощностей (%)</label>
 <input type="number" step="0.01" name="capacity_usage" value="{{ product.capacity_usage or '' }}">
</div>
 <div class="form-group">
 <label>Объем экспорта за прошлый год</label>
 <input type="number" step="0.01" name="export_volume_last_year" value="{{ product.export_volume_last_year or '' }}">
</div>
 <div class="form-group">
 <label>Страны экспорта</label>
 <input type="text" name="export_countries" value="{{ product.export_countries or '' }}">
</div>
 <div class="form-group">
 <label>Код ТН ВЭД</label>
 <input type="text" name="tnved_code" value="{{ product.tnved_code or '' }}">
</div>
 <div class="form-group">
 <div class="checkbox-group">
 <input type="checkbox" name="has_government_orders" {% if product.has_government_orders %}checked{% endif %}>
 <label>Есть госзаказы</label>
</div>
</div>
 <div class="form-group">
 <div class="checkbox-group">
 <input type="checkbox" name="has_export" {% if product.has_export %}checked{% endif %}>
 <label>Есть экспорт</label>
</div>
</div>
</div>
</div>
 {% endfor %}
</div>
 <button type="button" class="btn btn-success add-item-btn" onclick="addProduct()">+ Добавить продукт</button>
</div>
</div>

 <!-- Дополнительные данные -->
 <div id="meta" class="tab-content">
 <div class="card">
 <h2>Дополнительная информация</h2>
 <form id="metaForm">
 <div class="form-grid">
 <div class="form-group">
 <label>Отрасль Spark</label>
 <input type="text" name="industry_spark" value="{{ meta.industry_spark if meta else '' }}">
</div>
 <div class="form-group">
 <label>Отрасль справочника</label>
 <input type="text" name="industry_directory" value="{{ meta.industry_directory if meta else '' }}">
</div>
 <div class="form-group">
 <label>Реестр развития</label>
 <input type="text" name="registry_development" value="{{ meta.registry_development if meta else '' }}">
</div>
 <div class="form-group full-width">
 <label>Ссылки на презентации</label>
 <textarea name="presentation_links">{{ meta.presentation_links if meta else '' }}</textarea>
</div>
 <div class="form-group full-width">
 <label>Прочие примечания</label>
 <textarea name="other_notes">{{ meta.other_notes if meta else '' }}</textarea>
</div>
</div>
</form>
</div>
</div>
</div>

 <script>
 let currentTab = 'general';

 function switchTab(tabName) {
 // Hide all tabs
 document.querySelectorAll('.tab-content').forEach(content => {
 content.classList.remove('active');
 });
 
 // Remove active from all tab buttons
 document.querySelectorAll('.tab').forEach(tab => {
 tab.classList.remove('active');
 });
 
 // Show selected tab
 document.getElementById(tabName).classList.add('active');
 event.target.classList.add('active');
 
 currentTab = tabName;
 }

 function removeRow(btn) {
 btn.closest('tr').remove();
 }

 function removeAsset(btn) {
 btn.closest('.item-row').remove();
 }

 function removeProduct(btn) {
 btn.closest('.item-row').remove();
 }

 function addMetricRow() {
 const tbody = document.getElementById('metricsBody');
 const newRow = document.createElement('tr');
 newRow.innerHTML = `
 <td><input type="number" name="year" required></td>
 <td><input type="number" step="0.01" name="revenue"></td>
 <td><input type="number" step="0.01" name="profit"></td>
 <td><input type="number" name="total_employees"></td>
 <td><input type="number" name="moscow_employees"></td>
 <td><input type="number" step="0.01" name="total_fot"></td>
 <td><input type="number" step="0.01" name="moscow_fot"></td>
 <td><input type="number" step="0.01" name="avg_salary_total"></td>
 <td><input type="number" step="0.01" name="avg_salary_moscow"></td>
 <td><input type="number" step="0.01" name="investments"></td>
 <td><input type="number" step="0.01" name="export_volume"></td>
 <td><button type="button" class="remove-btn" onclick="removeRow(this)"></button></td>
 `;
 tbody.appendChild(newRow);
 }

 function addTaxRow() {
 const tbody = document.getElementById('taxesBody');
 const newRow = document.createElement('tr');
 newRow.innerHTML = `
 <td><input type="number" name="year" required></td>
 <td><input type="number" step="0.01" name="total_taxes_moscow"></td>
 <td><input type="number" step="0.01" name="profit_tax"></td>
 <td><input type="number" step="0.01" name="property_tax"></td>
 <td><input type="number" step="0.01" name="land_tax"></td>
 <td><input type="number" step="0.01" name="ndfl"></td>
 <td><input type="number" step="0.01" name="transport_tax"></td>
 <td><input type="number" step="0.01" name="other_taxes"></td>
 <td><input type="number" step="0.01" name="excise"></td>
 <td><button type="button" class="remove-btn" onclick="removeRow(this)"></button></td>
 `;
 tbody.appendChild(newRow);
 }

 function addAsset() {
 const container = document.getElementById('assetsContainer');
 const count = container.children.length + 1;
 const newAsset = document.createElement('div');
 newAsset.className = 'item-row';
 newAsset.innerHTML = `
 <div class="item-header">
 <span class="item-title">Новый актив #${count}</span>
 <button type="button" class="remove-btn" onclick="removeAsset(this)"> Удалить</button>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Кадастровый номер земли</label>
 <input type="text" name="cadastral_number_land">
</div>
 <div class="form-group">
 <label>Площадь земли (кв.м)</label>
 <input type="number" step="0.01" name="land_area">
</div>
 <div class="form-group">
 <label>Использование земли</label>
 <input type="text" name="land_usage">
</div>
 <div class="form-group">
 <label>Тип собственности земли</label>
 <input type="text" name="land_ownership_type">
</div>
 <div class="form-group">
 <label>Собственник земли</label>
 <input type="text" name="land_owner">
</div>
 <div class="form-group">
 <label>Кадастровый номер здания</label>
 <input type="text" name="cadastral_number_building">
</div>
 <div class="form-group">
 <label>Площадь здания (кв.м)</label>
 <input type="number" step="0.01" name="building_area">
</div>
 <div class="form-group">
 <label>Использование здания</label>
 <input type="text" name="building_usage">
</div>
 <div class="form-group">
 <label>Тип здания</label>
 <input type="text" name="building_type">
</div>
 <div class="form-group">
 <label>Назначение здания</label>
 <input type="text" name="building_purpose">
</div>
 <div class="form-group">
 <label>Тип собственности здания</label>
 <input type="text" name="building_ownership_type">
</div>
 <div class="form-group">
 <label>Собственник здания</label>
 <input type="text" name="building_owner">
</div>
 <div class="form-group">
 <label>Производственная площадь (кв.м)</label>
 <input type="number" step="0.01" name="production_area">
</div>
 <div class="form-group full-width">
 <label>Сводная информация об имуществе</label>
 <textarea name="property_summary"></textarea>
</div>
</div>
 `;
 container.appendChild(newAsset);
 }

 function addProduct() {
 const container = document.getElementById('productsContainer');
 const count = container.children.length + 1;
 const newProduct = document.createElement('div');
 newProduct.className = 'item-row';
 newProduct.innerHTML = `
 <div class="item-header">
 <span class="item-title">Новый продукт #${count}</span>
 <button type="button" class="remove-btn" onclick="removeProduct(this)"> Удалить</button>
</div>
 <div class="form-grid">
 <div class="form-group">
 <label>Название продукта</label>
 <input type="text" name="product_name">
</div>
 <div class="form-group">
 <label>Стандартизированный продукт</label>
 <input type="text" name="standardized_product">
</div>
 <div class="form-group">
 <label>Коды ОКПД2</label>
 <input type="text" name="okpd2_codes">
</div>
 <div class="form-group">
 <label>Типы продукции</label>
 <input type="text" name="product_types">
</div>
 <div class="form-group">
 <label>Каталог продукции</label>
 <input type="text" name="product_catalog">
</div>
 <div class="form-group">
 <label>Загрузка мощностей (%)</label>
 <input type="number" step="0.01" name="capacity_usage">
</div>
 <div class="form-group">
 <label>Объем экспорта за прошлый год</label>
 <input type="number" step="0.01" name="export_volume_last_year">
</div>
 <div class="form-group">
 <label>Страны экспорта</label>
 <input type="text" name="export_countries">
</div>
 <div class="form-group">
 <label>Код ТН ВЭД</label>
 <input type="text" name="tnved_code">
</div>
 <div class="form-group">
 <div class="checkbox-group">
 <input type="checkbox" name="has_government_orders">
 <label>Есть госзаказы</label>
</div>
</div>
 <div class="form-group">
 <div class="checkbox-group">
 <input type="checkbox" name="has_export">
 <label>Есть экспорт</label>
</div>
</div>
</div>
 `;
 container.appendChild(newProduct);
 }

 async function saveAllChanges() {
 try {
 // Collect all data
 const data = {
 general: collectFormData('generalForm'),
 metrics: collectTableData('metricsTable'),
 taxes: collectTableData('taxesTable'),
 assets: collectAssetsData(),
 products: collectProductsData(),
 meta: collectFormData('metaForm')
 };

 const response = await fetch('/organizations/{{ org.id }}/edit-full', {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json'
 },
 body: JSON.stringify(data)
 });

 if (response.ok) {
 showAlert('success', 'Все изменения успешно сохранены!');
 setTimeout(() => {
 window.location.href = '/organizations/{{ org.id }}';
 }, 1500);
 } else {
 const error = await response.json();
 showAlert('error', 'Ошибка: ' + (error.detail || 'Неизвестная ошибка'));
 }
 } catch (error) {
 showAlert('error', 'Ошибка при сохранении: ' + error.message);
 }
 }

 function collectFormData(formId) {
 const form = document.getElementById(formId);
 const data = {};
 const formData = new FormData(form);
 
 for (let [key, value] of formData.entries()) {
 if (form.querySelector(`[name="${key}"]`)?.type === 'checkbox') {
 data[key] = form.querySelector(`[name="${key}"]`).checked;
 } else {
 data[key] = value || null;
 }
 }
 
 return data;
 }

 function collectTableData(tableId) {
 const table = document.getElementById(tableId);
 const rows = table.querySelectorAll('tbody tr');
 const data = [];

 rows.forEach(row => {
 const rowData = {
 id: row.dataset.id || null
 };
 
 row.querySelectorAll('input').forEach(input => {
 if (input.name) {
 rowData[input.name] = input.value || null;
 }
 });
 
 data.push(rowData);
 });

 return data;
 }

 function collectAssetsData() {
 const container = document.getElementById('assetsContainer');
 const items = container.querySelectorAll('.item-row');
 const data = [];

 items.forEach(item => {
 const itemData = {
 id: item.dataset.id || null
 };
 
 item.querySelectorAll('input, textarea').forEach(field => {
 if (field.name) {
 itemData[field.name] = field.value || null;
 }
 });
 
 data.push(itemData);
 });

 return data;
 }

 function collectProductsData() {
 const container = document.getElementById('productsContainer');
 const items = container.querySelectorAll('.item-row');
 const data = [];

 items.forEach(item => {
 const itemData = {
 id: item.dataset.id || null
 };
 
 item.querySelectorAll('input, textarea').forEach(field => {
 if (field.name) {
 if (field.type === 'checkbox') {
 itemData[field.name] = field.checked;
 } else {
 itemData[field.name] = field.value || null;
 }
 }
 });
 
 data.push(itemData);
 });

 return data;
 }

 function showAlert(type, message) {
 const successAlert = document.getElementById('successAlert');
 const errorAlert = document.getElementById('errorAlert');
 
 if (type === 'success') {
 successAlert.textContent = message;
 successAlert.style.display = 'block';
 errorAlert.style.display = 'none';
 } else {
 errorAlert.textContent = message;
 errorAlert.style.display = 'block';
 successAlert.style.display = 'none';
 }
 
 window.scrollTo({ top: 0, behavior: 'smooth' });
 }
</script>
</body>
</html>
