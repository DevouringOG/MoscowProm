<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Добавить предприятие - MosProm</title>
 <link rel="stylesheet" href="/static/css/main.css">
 <style>
 body {
 background: var(--body-bg);
 margin: 0;
 padding: 0;
 }

 .page-header {
 background: var(--card-bg);
 border-bottom: 1px solid var(--border-color);
 padding: 24px;
 margin-bottom: 0;
 display: flex;
 justify-content: space-between;
 align-items: center;
 }

 .header-left {
 display: flex;
 align-items: center;
 gap: 24px;
 }

 .header-logo {
 height: 60px;
 width: auto;
 }

 .page-title-section {
 background: var(--card-bg);
 padding: 20px 30px;
 border-bottom: 1px solid var(--border-color);
 margin-bottom: 0;
 }

 .page-title {
 font-size: 24px;
 font-weight: 700;
 color: var(--text-primary);
 text-transform: uppercase;
 letter-spacing: 0.5px;
 margin: 0;
 }

 .header-actions {
 display: flex;
 gap: 12px;
 }

 .btn-secondary {
 padding: 12px 24px;
 background: transparent;
 color: var(--text-primary);
 border: 2px solid var(--border-color);
 font-size: 14px;
 font-weight: 500;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 }

 .btn-secondary:hover {
 border-color: var(--accent-dark);
 color: var(--accent-dark);
 }

 .main-content {
 max-width: 1200px;
 margin: 0 auto;
 padding: 0 24px 40px 24px;
 }

 .form-card {
 background: var(--card-bg);
 border: 1px solid var(--border-color);
 padding: 40px;
 margin-bottom: 24px;
 }

 .section-title {
 font-size: 16px;
 font-weight: 700;
 color: var(--text-primary);
 margin-bottom: 20px;
 padding-bottom: 12px;
 border-bottom: 2px solid var(--border-color);
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .form-grid {
 display: grid;
 grid-template-columns: repeat(2, 1fr);
 gap: 20px;
 margin-bottom: 30px;
 }

 .form-grid-full {
 display: grid;
 grid-template-columns: 1fr;
 gap: 20px;
 margin-bottom: 30px;
 }

 .form-group {
 display: flex;
 flex-direction: column;
 gap: 8px;
 }

 .form-label {
 font-size: 13px;
 font-weight: 600;
 color: var(--text-primary);
 text-transform: uppercase;
 letter-spacing: 0.3px;
 }

 .form-label.required::after {
 content: " *";
 color: #dc3545;
 }

 .form-input,
 .form-select,
 .form-textarea {
 padding: 12px;
 border: 1px solid var(--border-color);
 font-size: 14px;
 color: var(--text-primary);
 background: var(--card-bg);
 transition: border-color 0.3s;
 }

 .form-input:focus,
 .form-select:focus,
 .form-textarea:focus {
 outline: none;
 border-color: var(--accent-dark);
 }

 .form-textarea {
 resize: vertical;
 min-height: 80px;
 font-family: inherit;
 }

 .form-hint {
 font-size: 12px;
 color: var(--text-secondary);
 }

 .form-group-with-button {
 display: flex;
 gap: 8px;
 align-items: flex-end;
 }

 .form-group-with-button .form-group {
 flex: 1;
 }

 .btn-load-fns {
 width: 100%;
 padding: 14px 20px;
 background: rgba(0, 123, 255, 0.9);
 color: white;
 border: none;
 font-size: 14px;
 font-weight: 700;
 cursor: pointer;
 transition: all 0.3s ease;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 display: flex;
 align-items: center;
 justify-content: center;
 gap: 8px;
 }

 .btn-load-fns:hover {
 background: rgba(0, 123, 255, 1);
 transform: translateY(-1px);
 box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
 }

 .btn-load-fns:disabled {
 background: rgba(0, 123, 255, 0.4);
 cursor: not-allowed;
 transform: none;
 box-shadow: none;
 }

 .form-actions {
 display: flex;
 gap: 12px;
 padding-top: 20px;
 border-top: 1px solid var(--border-color);
 }

 .btn {
 padding: 14px 32px;
 border: none;
 font-size: 14px;
 font-weight: 600;
 cursor: pointer;
 text-decoration: none;
 display: inline-flex;
 align-items: center;
 gap: 8px;
 transition: all 0.3s ease;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .btn-primary {
 background: var(--accent-dark);
 color: var(--card-bg);
 }

 .btn-primary:hover {
 background: #5568d3;
 transform: translateY(-1px);
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
 }

 .btn-cancel {
 background: transparent;
 color: var(--text-primary);
 border: 2px solid var(--border-color);
 }

 .btn-cancel:hover {
 border-color: var(--accent-dark);
 color: var(--accent-dark);
 }

 .alert {
 padding: 16px;
 margin-bottom: 20px;
 border: 1px solid;
 }

 .alert-success {
 background: #d4edda;
 border-color: #c3e6cb;
 color: #155724;
 }

 .alert-error {
 background: #f8d7da;
 border-color: #f5c6cb;
 color: #721c24;
 }

 .collapsible-section {
 margin-bottom: 24px;
 }

 .section-header {
 padding: 16px;
 background: var(--body-bg);
 border: 1px solid var(--border-color);
 cursor: pointer;
 display: flex;
 justify-content: space-between;
 align-items: center;
 transition: all 0.3s;
 }

 .section-header:hover {
 background: var(--accent-light);
 }

 .section-header-title {
 font-size: 14px;
 font-weight: 700;
 text-transform: uppercase;
 letter-spacing: 0.5px;
 }

 .section-toggle {
 font-size: 16px;
 font-weight: 700;
 }

 .section-content {
 border: 1px solid var(--border-color);
 border-top: none;
 padding: 24px;
 display: none;
 }

 .section-content.active {
 display: block;
 }
 </style>
</head>
<body>
 <!-- Page Header -->
 <div class="page-header">
 <div class="header-left">
 <img src="/static/logo.svg" alt="MosProm" class="header-logo">
 </div>
 <div class="header-actions">
 <a href="/organizations" class="btn-secondary">ПРЕДПРИЯТИЯ</a>
 <a href="/analytics" class="btn-secondary">АНАЛИТИКА</a>
 <a href="/upload" class="btn-secondary">ЗАГРУЗКА</a>
 </div>
 </div>

 <div class="main-content">
 <div class="page-title-section">
 <h1 class="page-title">ДОБАВИТЬ ПРЕДПРИЯТИЕ</h1>
 </div>

 <!-- Alert Messages -->
 <div id="alertContainer"></div>

 <!-- Main Form Card -->
 <form id="organizationForm" class="form-card">
 <!-- Basic Information Section -->
 <div class="section-title">Основная информация</div>
 
 <div class="form-grid">
 <div class="form-group">
 <label class="form-label required">ИНН</label>
 <input type="text" name="inn" id="innInput" class="form-input" required maxlength="12" pattern="[0-9]{10,12}">
 <span class="form-hint">10 или 12 цифр</span>
 </div>

 <div class="form-group">
 <label class="form-label required">Название организации</label>
 <input type="text" name="name" class="form-input" required>
 </div>
 </div>

 <div class="form-grid-full">
 <button type="button" class="btn-load-fns" id="loadFromFnsBtn" onclick="loadFromFNS()" style="margin-bottom: 20px;">⟳ ЗАГРУЗИТЬ ДАННЫЕ ИЗ ФНС</button>
 </div>

 <div class="form-grid-full">
 <div class="form-group">
 <label class="form-label required">Полное наименование</label>
 <input type="text" name="full_name" class="form-input" required>
 </div>
 </div>

 <div class="form-grid-full">
 <div class="form-group">
 <label class="form-label required">Юридический адрес</label>
 <input type="text" name="legal_address" class="form-input" required>
 </div>
 </div>

 <div class="form-grid">
 <div class="form-group">
 <label class="form-label required">Основной ОКВЭД</label>
 <input type="text" name="main_okved" class="form-input" required>
 </div>

 <div class="form-group">
 <label class="form-label">Название ОКВЭД</label>
 <input type="text" name="main_okved_name" class="form-input">
 </div>
 </div>

 <div class="form-grid">
 <div class="form-group">
 <label class="form-label required">Статус</label>
 <input type="text" name="status_final" class="form-input" required>
 </div>

 <div class="form-group">
 <label class="form-label required">Дата регистрации</label>
 <input type="date" name="registration_date" class="form-input" required>
 </div>
 </div>

 <div class="form-grid">
 <div class="form-group">
 <label class="form-label">Основная отрасль</label>
 <input type="text" name="main_industry" class="form-input">
 </div>

 <div class="form-group">
 <label class="form-label">Подотрасль</label>
 <input type="text" name="main_subindustry" class="form-input">
 </div>
 </div>

 <!-- Collapsible Sections -->
 
 <!-- Addresses Section -->
 <div class="collapsible-section">
 <div class="section-header" onclick="toggleSection('addresses')">
 <span class="section-header-title">Дополнительные адреса</span>
 <span class="section-toggle" id="toggle-addresses">▼</span>
 </div>
 <div class="section-content" id="content-addresses">
 <div class="form-grid-full">
 <div class="form-group">
 <label class="form-label">Производственный адрес</label>
 <input type="text" name="production_address" class="form-input">
 </div>

 <div class="form-group">
 <label class="form-label">Дополнительный адрес</label>
 <input type="text" name="additional_address" class="form-input">
 </div>
 </div>

 <div class="form-grid">
 <div class="form-group">
 <label class="form-label">Район</label>
 <input type="text" name="district" class="form-input">
 </div>

 <div class="form-group">
 <label class="form-label">Регион</label>
 <input type="text" name="region" class="form-input">
 </div>
 </div>
 </div>
 </div>

 <!-- Contact Information Section -->
 <div class="collapsible-section">
 <div class="section-header" onclick="toggleSection('contacts')">
 <span class="section-header-title">Контактная информация</span>
 <span class="section-toggle" id="toggle-contacts">▼</span>
 </div>
 <div class="section-content" id="content-contacts">
 <div class="form-grid">
 <div class="form-group">
 <label class="form-label">Телефон</label>
 <input type="tel" name="phone" class="form-input">
 </div>

 <div class="form-group">
 <label class="form-label">Email</label>
 <input type="email" name="email" class="form-input">
 </div>
 </div>

 <div class="form-grid">
 <div class="form-group">
 <label class="form-label">Веб-сайт</label>
 <input type="url" name="website" class="form-input">
 </div>

 <div class="form-group">
 <label class="form-label">Email руководителя</label>
 <input type="email" name="head_email" class="form-input">
 </div>
 </div>
 </div>
 </div>

 <!-- Company Information Section -->
 <div class="collapsible-section">
 <div class="section-header" onclick="toggleSection('company')">
 <span class="section-header-title">Сведения о компании</span>
 <span class="section-toggle" id="toggle-company">▼</span>
 </div>
 <div class="section-content" id="content-company">
 <div class="form-grid">
 <div class="form-group">
 <label class="form-label">Размер компании</label>
 <select name="company_size" class="form-select">
 <option value="">Не указано</option>
 <option value="Микро">Микро</option>
 <option value="Малое">Малое</option>
 <option value="Среднее">Среднее</option>
 <option value="Крупное">Крупное</option>
 </select>
 </div>

 <div class="form-group">
 <label class="form-label">ФИО руководителя</label>
 <input type="text" name="head_name" class="form-input">
 </div>
 </div>

 <div class="form-grid-full">
 <div class="form-group">
 <label class="form-label">Информация о компании</label>
 <textarea name="company_info" class="form-textarea"></textarea>
 </div>
 </div>
 </div>
 </div>

 <!-- Form Actions -->
 <div class="form-actions">
 <button type="submit" class="btn btn-primary">Сохранить предприятие</button>
 <a href="/organizations" class="btn btn-cancel">Отмена</a>
 </div>
 </form>
 </div>

 <script>
 function toggleSection(sectionId) {
 const content = document.getElementById(`content-${sectionId}`);
 const toggle = document.getElementById(`toggle-${sectionId}`);
 
 if (content.classList.contains('active')) {
 content.classList.remove('active');
 toggle.textContent = '▼';
 } else {
 content.classList.add('active');
 toggle.textContent = '▲';
 }
 }

 document.getElementById('organizationForm').addEventListener('submit', async (e) => {
 e.preventDefault();
 
 const formData = new FormData(e.target);
 const data = {};
 
 for (const [key, value] of formData.entries()) {
 if (value.trim() !== '') {
 data[key] = value;
 }
 }

 try {
 const response = await fetch('/organizations', {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json',
 },
 body: JSON.stringify(data)
 });

 const result = await response.json();

 if (response.ok) {
 showAlert('success', `УСПЕШНО: Предприятие "${data.name}" добавлено`);
 setTimeout(() => {
 window.location.href = `/organizations/${result.organization_id}`;
 }, 1500);
 } else {
 showAlert('error', `ОШИБКА: ${result.detail || 'Не удалось добавить предприятие'}`);
 }
 } catch (error) {
 showAlert('error', `ОШИБКА: ${error.message}`);
 }
 });

 function showAlert(type, message) {
 const container = document.getElementById('alertContainer');
 const alert = document.createElement('div');
 alert.className = `alert alert-${type}`;
 alert.textContent = message;
 container.appendChild(alert);

 setTimeout(() => {
 alert.remove();
 }, 5000);
 }

 async function loadFromFNS() {
 const innInput = document.getElementById('innInput');
 const btn = document.getElementById('loadFromFnsBtn');
 const inn = innInput.value.trim();

 // Validate INN
 if (!inn) {
 showAlert('error', 'Введите ИНН для загрузки данных из ФНС');
 innInput.focus();
 return;
 }

 if (!/^[0-9]{10,12}$/.test(inn)) {
 showAlert('error', 'ИНН должен содержать 10 или 12 цифр');
 innInput.focus();
 return;
 }

 // Disable button and show loading
 btn.disabled = true;
 const originalText = btn.textContent;
 btn.textContent = '⟳ Загрузка...';

 try {
 const response = await fetch(`/api/fns/organization/${inn}`);
 const data = await response.json();

 if (response.ok && data.status === 'success') {
 // Fill form fields with FNS data
 const fnsData = data.data;
 
 // Basic information
 if (fnsData.name) {
 document.querySelector('input[name="name"]').value = fnsData.name;
 }
 if (fnsData.full_name) {
 document.querySelector('input[name="full_name"]').value = fnsData.full_name;
 }
 
 // Address
 if (fnsData.legal_address) {
 document.querySelector('input[name="legal_address"]').value = fnsData.legal_address;
 }
 
 // OKVED
 if (fnsData.main_okved) {
 document.querySelector('input[name="main_okved"]').value = fnsData.main_okved;
 }
 if (fnsData.main_okved_name) {
 document.querySelector('input[name="main_okved_name"]').value = fnsData.main_okved_name;
 }
 
 // Head
 if (fnsData.head_name) {
 document.querySelector('input[name="head_name"]').value = fnsData.head_name;
 }
 
 // Registration date
 if (fnsData.registration_date) {
 document.querySelector('input[name="registration_date"]').value = fnsData.registration_date;
 }

 // Status
 if (fnsData.status) {
 document.querySelector('input[name="status_final"]').value = fnsData.status;
 }

 showAlert('success', 'Данные успешно загружены из ФНС! Проверьте и дополните информацию.');
 
 // Scroll to top to show the filled data
 window.scrollTo({ top: 0, behavior: 'smooth' });
 } else {
 showAlert('error', data.detail || 'Не удалось получить данные из ФНС');
 }
 } catch (error) {
 showAlert('error', `Ошибка при загрузке данных из ФНС: ${error.message}`);
 } finally {
 // Re-enable button
 btn.disabled = false;
 btn.textContent = originalText;
 }
 }
 </script>
</body>
</html>
